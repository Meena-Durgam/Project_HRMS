{% extends 'base_superadmin.html' %}
{% load static %}
{% block title %}Superadmin Dashboard{% endblock %}

{% block content %}
<div class="content container-fluid">

  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h3 class="page-title">Superadmin Dashboard</h3>
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Superadmin</a></li>
          <li class="breadcrumb-item active">Dashboard</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row">
    <div class="col-md-4">
      <div class="card dash-widget">
        <div class="card-body">
          <span class="dash-widget-icon bg-1"><i class="la la-building"></i></span>
          <div class="dash-widget-info">
            <h3>{{ companies.count }}</h3>
            <span>Total Companies</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card dash-widget">
        <div class="card-body">
          <span class="dash-widget-icon bg-2"><i class="la la-check-circle"></i></span>
          <div class="dash-widget-info">
            <h3>{{ active_companies|default:"0" }}</h3>
            <span>Active Companies</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card dash-widget">
        <div class="card-body">
          <span class="dash-widget-icon bg-3"><i class="la la-users"></i></span>
          <div class="dash-widget-info">
            <h3>{{ total_subscribers|default:"0" }}</h3>
            <span>Total Subscribers</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row">
    <div class="col-md-7">
      <div class="card">
        <div class="card-header">
          <h5>Companies Registered This Week: <span class="badge bg-info">{{ companies_registered_this_week }}</span></h5>
        </div>
        <div class="card-body">
          <canvas id="companiesBarChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card">
        <div class="card-header"><h5 class="card-title mb-0">Top Plans</h5></div>
        <div class="card-body">
          <canvas id="plansPieChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Recently Registered -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between">
          <h5 class="card-title mb-0">Recently Registered</h5>
          <a href="{% url 'company_list' %}">View All</a>
        </div>
        <div class="card-body">
          {% for company in recent_registered %}
          <div class="d-flex justify-content-between mb-2">
            <div>
              <strong>{{ company.name }}</strong><br>
              <small>{{ company.plan_type }} ({{ company.user_count }} Users)</small>
            </div>
          </div>
          {% empty %}
          <p>No recent companies.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Recently Expired Plans -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between">
          <h5 class="card-title mb-0">Recent Plan Expired</h5>
          <span class="badge bg-danger">Expired</span>
        </div>
        <div class="card-body">
          {% for sub in recently_expired %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong>{{ sub.company.name }}</strong><br>
              <small>Expired: {{ sub.expiry_date|date:"d M Y" }}<br>{{ sub.plan_type }}</small>
            </div>
            <a href="#" class="btn btn-sm btn-outline-primary">Send Reminder</a>
          </div>
          {% empty %}
          <p>No expired plans.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JSON-safe chart data -->
{{ bar_chart_labels|json_script:"barLabels" }}
{{ bar_chart_data|json_script:"barData" }}
{{ company_names_tooltip|json_script:"barTooltips" }}
{{ pie_chart_labels|json_script:"pieLabels" }}
{{ pie_chart_data|json_script:"pieData" }}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart Scripts -->
<script>
  const barLabels = JSON.parse(document.getElementById('barLabels').textContent);
  const barData = JSON.parse(document.getElementById('barData').textContent);
  const barTooltips = JSON.parse(document.getElementById('barTooltips').textContent);
  const pieLabels = JSON.parse(document.getElementById('pieLabels').textContent);
  const pieData = JSON.parse(document.getElementById('pieData').textContent);

  new Chart(document.getElementById('companiesBarChart'), {
    type: 'bar',
    data: {
      labels: barLabels,
      datasets: [{
        label: 'Companies',
        data: barData,
        backgroundColor: '#ff6600'
      }]
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const index = context.dataIndex;
              const names = barTooltips[index];
              return Companies: ${context.formattedValue}\n${names};
            }
          }
        }
      }
    }
  });

  new Chart(document.getElementById('plansPieChart'), {
    type: 'doughnut',
    data: {
      labels: pieLabels,
      datasets: [{
        data: pieData,
        backgroundColor: ['#f39c12', '#00a65a', '#f56954', '#007bff', '#6c757d']
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
</script>
{% endblock %}
