{% extends 'base.html' %}
{% load static %}
{% block title %}Qubits HRMS | Policies{% endblock %}

{% block content %}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title">Policies</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active">Policies</li>
            </ul>
        </div>
{% if request.user.role == 'company_owner' %}
<div class="col-auto float-right ml-auto">
    <a href="{% url 'add_policy' %}" class="btn add-btn">
        <i class="fa fa-plus"></i> Add Policy
    </a>
</div>
{% endif %}

    </div>
</div>

{% if messages %}
<div class="messages mt-2">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-bs-dismiss="alert">&times;</button>
    </div>
    {% endfor %}
</div>
{% endif %}
<form method="get" class="row g-3 align-items-end mb-4">
  <!-- Policy Name -->
  <div class="col-md-4">
    <label for="name" class="form-label">Policy Name</label>
    <input type="text"
           id="name"
           name="name"
           class="form-control py-2"
           placeholder="Enter Policy Name"
           value="{{ request.GET.name }}">
  </div>

  <!-- Created Date -->
  <div class="col-md-4">
    <label for="created_at" class="form-label">Created Date</label>
    <input type="date"
           id="created_at"
           name="created_at"
           class="form-control py-2 text-uppercase"
           value="{{ request.GET.created_at }}">
  </div>

  <!-- Search Button -->
  <div class="col-md-4 d-flex align-items-end">
    <button type="submit" class="btn btn-primary w-100 py-2">Search</button>
  </div>
</form>


<style>
  .entry-selector-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }

  .entry-input {
    width: 60px;
    padding: 4px 8px;
    font-size: 14px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 2px;
    box-shadow: none;
  }

  .entry-input::-webkit-outer-spin-button,
  .entry-input::-webkit-inner-spin-button {
    opacity: 1;
  }

  .entry-input[type="number"] {
    appearance: textfield;
    -moz-appearance: textfield;
  }
</style>

<form method="get" class="mb-3">
  <label for="page_size">Show
     <select name="page_size" id="page_size" onchange="this.form.submit()">
    <option value="5" {% if page_size == 5 %}selected{% endif %}>5</option>
    <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
    <option value="15" {% if page_size == 15 %}selected{% endif %}>15</option>
    <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
  </select>
  entries
  </label>
</form>

<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-striped custom-table mb-0 datatable">
                <thead>
                    <tr>
                        <th>SL.No.</th>
                        <th>Policy Name</th>
                        
                        <th>Created At</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                      {% if page_obj %}
                    {% for policy in policies %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ policy.name }}</td>
                        
                        <td>{{ policy.created_at|date:"d M Y" }}</td>
                        <td class="text-center">
                            <div class="dropdown dropdown-action">
                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown"><i class="material-icons">more_vert</i></a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="{% url 'view_policy' policy.id %}">
    <i class="fa fa-eye me-1"></i> View
</a>

                                    {% if request.user.role == 'company_owner' %}
<a class="dropdown-item" href="#" 
                                   data-bs-toggle="modal" 
                                   data-bs-target="#editPolicyModal{{ policy.id }}">
                                    <i class="fa fa-pencil me-1"></i> Edit
                                </a>                                    <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deletePolicyModal{{ policy.id }}">
    <i class="fa fa-trash m-r-5 "></i> Delete
</a>

</a>

                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>

                    <!-- Delete Modal -->
                   <div class="modal custom-modal fade" id="deletePolicyModal{{ policy.id }}" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center p-4 rounded-4">
      <div class="modal-body">
        <h3 class="mb-2 fw-semibold">Delete Policy</h3>
        <p class="text-muted mb-4" style="font-size: 14px;">Are you sure you want to delete this policy?</p>
        <form method="post" action="{% url 'delete_policy' policy.id %}">
          {% csrf_token %}
          <div class="row">
                            <div class="col-6">
                                <button type="submit" class="btn btn-outline-primary btn-block continue-btn">Delete</button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-secondary btn-block cancel-btn" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editPolicyModal{{ policy.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="modal-title mb-0">Edit Policy</h4>
                                <button type="button" class="close" data-bs-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <form method="post" action="{% url 'edit_policy' policy.id %}">
                                {% csrf_token %}
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Policy Name <span class="text-danger">*</span></label>
                                        <input type="text" name="name" value="{{ policy.name }}" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Description <span class="text-danger">*</span></label>
                                        <textarea name="description" id="ckeditor5-description-{{ policy.id }}" class="form-control" required>{{ policy.description }}</textarea>
                                    </div>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="submit" class="btn btn-primary">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                    {% endfor %}
                        {% else %}
        <tr>
            <td colspan="4" class="text-center text-muted">No policies found</td>
        </tr>
    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Show entry range info -->
<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        {% if page_obj.has_other_pages %}
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ total_entries }} entries
        {% else %}
            Showing {{ page_obj.paginator.count }} of {{ total_entries }} entries
        {% endif %}
    </div>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if request.GET.name %}name={{ request.GET.name }}&{% endif %}{% if request.GET.created_at %}created_at={{ request.GET.created_at }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?{% if request.GET.name %}name={{ request.GET.name }}&{% endif %}{% if request.GET.created_at %}created_at={{ request.GET.created_at }}&{% endif %}page={{ num }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if request.GET.name %}name={{ request.GET.name }}&{% endif %}{% if request.GET.created_at %}created_at={{ request.GET.created_at }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
</div>
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    {% for policy in policies %}
        ClassicEditor.create(document.querySelector('#ckeditor5-description-{{ policy.id }}'))
        .catch(error => console.error(error));
    {% endfor %}
});
</script>
{% endblock %}