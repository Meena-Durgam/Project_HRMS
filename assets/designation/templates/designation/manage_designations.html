{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Designations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<style>
    .add-btn {
        float: right;
        margin-top: -10px;
        margin-bottom: 20px;
    }
    .dropdown-toggle::after {
        display: none;
    }
    .table td {
        vertical-align: middle;
    }

    /* Red asterisk for required field labels */
    label.required::after {
        content: " *";
        color: red;
    }


.select-arrow-spacing {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;

  background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='30' viewBox='0 0 24 24' width='30' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;

  /* ðŸ‘‡ Arrow spacing from the right */
  background-position: right 14px center;

  /* ðŸ‘‡ Add right padding so text doesn't collide with the arrow */
  padding-right: 38px;

  background-size: 24px;
}
</style>
<style>
  .entry-selector-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }

  .entry-input {
    width: 60px;
    padding: 4px 8px;
    font-size: 14px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 2px;
    box-shadow: none;
  }

  .entry-input::-webkit-outer-spin-button,
  .entry-input::-webkit-inner-spin-button {
    opacity: 1;
  }

  .entry-input[type="number"] {
    appearance: textfield;
    -moz-appearance: textfield;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col-12 col-md">
            <h3 class="page-title">Designations</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active">Designations</li>
            </ul>
        </div>
        <button class="btn btn-primary rounded-pill add-btn" data-toggle="modal" data-target="#add_designation">
            <i class="fa fa-plus me-1"></i> Add Designation
        </button>
    </div>
</div>

<!-- Flash Messages -->
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Filter Form -->
<form method="get" class="row mb-3">
    <div class="col-md-3">
        <input type="text" name="name" value="{{ search_name }}" class="form-control" placeholder="Search By Designation Name">
    </div>
    <div class="col-md-3">
        <input type="text" name="department" value="{{ search_department }}" class="form-control" placeholder="Search By Department">
    </div>
    <div class="col-md-3">
        <select name="status" class="form-control custom-select-padding select-arrow-spacing ">
            <option value="">Select Status</option>
            <option value="Active" {% if search_status == "Active" %}selected{% endif %}>Active</option>
            <option value="Inactive" {% if search_status == "Inactive" %}selected{% endif %}>Inactive</option>
        </select>
    </div>
    <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100"style="height: 42px;">Filter</button>
    </div>
</form>

<form method="get" class="d-flex justify-content-between align-items-center mb-3">
    <div class="form-group mb-0">
        <label for="per_page">Show
            <select name="per_page" id="per_page" class="form-select d-inline-block w-auto"
                    onchange="this.form.submit();">
                {% for option in per_page_options %}
                    <option value="{{ option }}" {% if option == per_page %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        entries
        </label>
    </div>
</form>


<!-- Designation Table -->
<div class="table-responsive">
    <table class="table table-striped custom-table">
        <thead>
            <tr>
                <th>SL.No.</th>
                <th>Designation</th>
                <th>Department</th>
                <th>Status</th>
                <th class="text-center">Action</th>
            </tr>
        </thead>
        <tbody>
            {% if designations %}
                {% for desig in designations %}
                    <tr>
                        <td >{{ forloop.counter0|add:designations.start_index}}</td>
                        <td>{{ desig.name }}</td>
                        <td>{{ desig.department.name }}</td>
                        <td>{{ desig.status }}</td>
                        <td class="text-center">
    <div class="dropdown dropdown-action">
        <a href="#" class="dropdown-toggle text-secondary" data-toggle="dropdown">
            <i class="material-icons">more_vert</i>
        </a>
        <div class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" 
               href="#" 
               data-toggle="modal" 
               data-target="#editDesignationModal{{ desig.id }}">
               <i class="fa fa-pencil me-2"></i> Edit
            </a>
            <button type="button" 
                    class="dropdown-item text-danger" 
                    data-toggle="modal" 
                    data-target="#deleteDesignationModal{{ desig.id }}">
                <i class="fa fa-trash-o me-2"></i> Delete
            </button>
        </div>
    </div>
</td>

                    </tr>

                    <!-- Edit Modal -->
                    <div class="modal custom-modal fade" id="editDesignationModal{{ desig.id }}" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content p-3">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="edit_designation_id" value="{{ desig.id }}">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit Designation</h5>
                                        <button type="button" class="close close-edit-designation" data-dismiss="modal">&times;</button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label>Designation Name <span class="text-danger">*</span></label>
                                            <input type="text" name="name" class="form-control" value="{{ desig.name }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label>Department <span class="text-danger">*</span></label>
                                            <select name="department" class="form-control custom-select-padding select-arrow-spacing">
                                                {% for dept in form.fields.department.queryset %}
                                                    <option value="{{ dept.id }}" {% if desig.department.id == dept.id %}selected{% endif %}>{{ dept.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label>Status <span class="text-danger">*</span></label>
                                            <select name="status" class="form-control custom-select-padding select-arrow-spacing">
                                                <option value="" disabled {% if not desig.status %}selected{% endif %}>Select Status</option>
                                                <option value="Active" {% if desig.status == 'Active' %}selected{% endif %}>Active</option>
                                                <option value="Inactive" {% if desig.status == 'Inactive' %}selected{% endif %}>Inactive</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="modal-footer justify-content-center border-0">
                                        <button class="btn btn-primary">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Delete Designation Modal -->
<div class="modal custom-modal fade" id="deleteDesignationModal{{ desig.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel{{ desig.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{% url 'delete_designation' desig.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-header text-center">
                        <h3>Delete Designation</h3>
                        <p>Are you sure you want to delete <strong>{{ desig.name }}</strong>?</p>
                    </div>
                    <div class="modal-btn delete-action mt-4">
                        <div class="row">
                            <div class="col-6">
                                <button type="submit" class="btn btn-outline-primary btn-block continue-btn">Delete</button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-secondary btn-block cancel-btn" data-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
 Â Â Â </div>
</div>

                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">No designations found.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center">
    <div>
        {% with start=designations.start_index|default_if_none:0 end=designations.end_index|default_if_none:0 %}
            Showing {{ start }} to {{ end }} of {{ paginator.count }} entries
        {% endwith %}
    </div>

    <nav>
        <ul class="pagination mb-0">
            {% if designations.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ designations.previous_page_number }}&per_page={{ per_page }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for i in designations.paginator.page_range %}
                <li class="page-item {% if i == designations.number %}active{% endif %}">
                    <a class="page-link" href="?page={{ i }}&per_page={{ per_page }}">{{ i }}</a>
                </li>
            {% endfor %}

            {% if designations.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ designations.next_page_number }}&per_page={{ per_page }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
</div>


<!-- Add Modal -->
<div class="modal custom-modal fade" id="add_designation" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Designation</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <!-- Designation Name -->
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label required">
                            {{ form.name.label }}
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger mt-1">{{ form.name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Department -->
                    <!-- Department Field -->
<div class="mb-3">
    <label for="{{ form.department.id_for_label }}" class="form-label required">
        {{ form.department.label }}
    </label>
    {{ form.department|add_class:"form-control select-arrow-spacing" }}
    {% if form.department.errors %}
        <div class="text-danger mt-1">{{ form.department.errors.0 }}</div>
    {% endif %}
</div>


                    <!-- Status -->
                    <div class="mb-3">
                        <label for="{{ form.status.id_for_label }}" class="form-label required">
                            {{ form.status.label }}
                        </label>
                        {{ form.status|add_class:"form-control select-arrow-spacing" }}
                        {% if form.status.errors %}
                            <div class="text-danger mt-1">{{ form.status.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="submit" name="add_designation" class="btn btn-primary px-4 py-2">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Clear Add Designation form whenever modal is closed
$('#add_designation').on('hidden.bs.modal', function () {
    $(this).find('form')[0].reset();
});

// Reset Edit Designation form on modal close or close button click
$('[id^="editDesignationModal"]').on('hidden.bs.modal', function () {
    $(this).find('form')[0].reset();
});

$(document).on('click', '.close-edit-designation', function () {
    const modal = $(this).closest('.modal');
    modal.find('form')[0].reset();
});
</script>

<script>
  $('#add_designation_modal').on('show.bs.modal', function () {
    $(this).find('form')[0].reset();
  });
</script>


{%Â endblockÂ %}
