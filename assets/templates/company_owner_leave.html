{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load leave_tags %} {# for dict_get custom filter #}
{% block title %}Qubits HRMS | Leave {% endblock %}

{% block content %}
<style>
/* Hide default arrow */

.select-arrow-spacing {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;

  background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='30' viewBox='0 0 24 24' width='30' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;

  /* ðŸ‘‡ Arrow spacing from the right */
  background-position: right 14px center;

  /* ðŸ‘‡ Add right padding so text doesn't collide with the arrow */
  padding-right: 38px;

  background-size: 24px;
}
</style>


<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title">Leave</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active">Leave</li>
            </ul>
        </div>
    </div>
</div>
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

    <!-- Filters -->
<form method="get" class="row g-2 mb-3 align-items-end">
    <div class="col-md-3">
        <label class="form-label">Employee Name</label>
        <input type="text" class="form-control form-control-lg" name="employee_name"
               placeholder="Employee Name" value="{{ filters.employee_name }}">
    </div>

    <div class="col-md-3">
        <label class="form-label">Leave Type</label>
        <select class="form-control form-control-lg custom-select-padding select-arrow-spacing" name="leave_type">
            <option value="">-- Select --</option>
            {% for type in leave_types %}
                <option value="{{ type.id }}"
                    {% if filters.leave_type|default_if_none:'' == type.id|stringformat:"s" %}selected{% endif %}>
                    {{ type.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Leave Status</label>
        <select class="form-control form-control-lg custom-select-padding select-arrow-spacing" name="status">
            <option value="">-- Select --</option>
            <option value="Approved" {% if filters.status == "Approved" %}selected{% endif %}>Approved</option>
            <option value="Pending" {% if filters.status == "Pending" %}selected{% endif %}>Pending</option>
            <option value="Rejected" {% if filters.status == "Rejected" %}selected{% endif %}>Rejected</option>
        </select>
    </div>

    <div class="col-md-3">
        <button type="submit" class="btn btn-primary btn-lg w-100">Search</button>
    </div>
</form>



    <!-- Leave Request Table -->
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>Employee</th>
                    <th>Leave Type</th>
                    <th>From</th>
                    <th>To</th>
                    <th>No of Days</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for leave in leave_requests %}
                <tr>
                   <td class="d-flex align-items-center gap-2">
    <img src="{% if leave.employee.profile and leave.employee.profile.profile_picture %}
                {{ leave.employee.profile.profile_picture.url }}
              {% else %}
                
              {% endif %}"
         alt="Avatar"
         class="rounded-circle"
         width="40"
         height="40"
         style="object-fit: cover;">
    <span>{{ leave.employee.first_name }} {{ leave.employee.last_name }}</span>
</td>


                    <td>{{ leave.leave_type.name }}</td>
                    <td>{{ leave.start_date|date:"d M Y" }}</td>
                    <td>{{ leave.end_date|date:"d M Y" }}</td>
                    <td>{{ leave.no_of_days }} day{% if leave.no_of_days > 1 %}s{% endif %}</td>
                    <td>{{ leave.reason }}</td>
                    <td>
                        {% if leave.status == 'Approved' %}
                            <span class="badge rounded-pill border border-success text-success">
                                <i class="bi bi-record-circle-fill text-success me-1"></i> Approved
                            </span>
                        {% elif leave.status == 'Rejected' %}
                            <span class="badge rounded-pill border border-danger text-danger">
                                <i class="bi bi-record-circle-fill text-danger me-1"></i> Rejected
                            </span>
                        {% else %}
                            <span class="badge rounded-pill border border-warning text-warning">
                                <i class="bi bi-record-circle-fill text-warning me-1"></i> Pending
                            </span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        {% if leave.status == 'Pending' %}
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="leave_id" value="{{ leave.id }}">
                            <button type="submit" name="action" value="approve" class="btn btn-outline-success btn-sm rounded-pill">Approve</button>
                            <button type="submit" name="action" value="reject" class="btn btn-outline-danger btn-sm rounded-pill">Reject</button>
                        </form>
                        {% else %}
                        <small class="text-muted">Processed</small>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-muted">No leave requests found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Optional: Bootstrap Bundle (if not loaded globally) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{%Â endblockÂ %}
