{% extends 'base.html' %}
{% block title %}Qubits HRMS | Estimate{% endblock %}
{% load widget_tweaks %}

{% block content %}
<div class="page-header mb-4">
  <div class="row align-items-center">
    <div class="col-12 col-md">
      <h3 class="page-title">{% if is_update %}Update{% else %}Create{% endif %} Estimate</h3>
      <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
        <li class="breadcrumb-item active">{% if is_update %}Update{% else %}Create{% endif %} Estimate</li>
      </ul>
    </div>
  </div>
</div>

<!-- Flash Messages -->
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="row p-3">
  <form method="POST">
    {% csrf_token %}

    {% if estimate_form.non_field_errors %}
      <div class="alert alert-danger">{{ estimate_form.non_field_errors }}</div>
    {% endif %}

    <!-- Estimate Form Fields -->
    <div class="row">
      {% for field in estimate_form %}
        {% if field.name not in 'discount,other_information,expiry_date' %}
          <div class="col-md-3 col-sm-6">
            <div class="form-group mb-3 {% if field.errors %}has-error{% endif %}">
              <label class="form-label" for="{{ field.id_for_label }}">{{ field.label|safe }}</label>
              {% render_field field class="form-control" %}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        {% elif field.name == 'expiry_date' %}
          <div class="col-md-3 col-sm-6">
            <div class="form-group mb-3 {% if field.errors %}has-error{% endif %}">
              <label class="form-label" for="{{ field.id_for_label }}">{{ field.label|safe }}</label>
              <div class="input-group date datepicker">
                {% render_field field class="form-control text-uppercase py-2", autocomplete="off", placeholder="DD/MM/YYYY" %}
               
              </div>
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Estimate Items Table -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-white">
            <thead>
              <tr>
                <th>SL.No.</th>
                <th>Item <span style="color:red;">*</span></th>
                <th>Description <span style="color:red;">*</span></th>
                <th>Unit Cost <span style="color:red;">*</span></th>
                <th>Qty <span style="color:red;">*</span></th>
                <th>Amount</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="item-formset">
              {{ item_formset.management_form }}
              {% for form in item_formset %}
                <tr class="estimate-item-form" data-form-index="{{ forloop.counter0 }}">
                  <td>{{ forloop.counter }}</td>
                  {{ form.id }}
                  <td>{% render_field form.item_name class="form-control" %}</td>
                  <td>{% render_field form.description class="form-control" %}</td>
                  <td>{% render_field form.unit_cost class="form-control unit-cost" %}</td>
                  <td>{% render_field form.quantity class="form-control quantity" %}</td>
                  <td><input type="text" class="form-control amount-field" readonly></td>
                  <td class="text-end">
                    {% if forloop.last %}
                      <a href="#" class="text-success add-item"><i class="fa fa-plus"></i></a>
                    {% else %}
                      <a href="#" class="text-danger remove-item"><i class="fa fa-trash"></i></a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Totals and Discount -->
    <div class="row justify-content-right">
      <div class="col-md-12">
        <div class="table-responsive">
          <table class="table table-hover table-white text-end">
            <tbody>
              <tr>
                <td><strong>Total</strong></td>
                <td><span id="total-amount">0.00</span></td>
              </tr>
              <tr>
                <td><strong>Tax</strong></td>
                <td><input class="form-control text-end" id="tax-amount" readonly value="0.00" type="text"></td>
              </tr>
              <tr>
                <td><strong>Discount (%)</strong></td>
                <td>{% render_field estimate_form.discount class="form-control text-end" %}</td>
              </tr>
              <tr>
                <td><strong>Discount Amount</strong></td>
                <td><input type="text" id="discount-amount" class="form-control text-end" readonly value="0.00"></td>
              </tr>
              <tr class="fw-bold fs-5">
                <td><strong>Grand Total</strong></td>
                <td><span id="grand-total">Rs 0.00</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Other Information -->
    <div class="form-group mt-3 {% if estimate_form.other_information.errors %}has-error{% endif %}">
      <label for="{{ estimate_form.other_information.id_for_label }}">{{ estimate_form.other_information.label|safe }}</label>
      {% render_field estimate_form.other_information class="form-control" %}
      {% if estimate_form.other_information.errors %}
        <div class="text-danger small">{{ estimate_form.other_information.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Submit Buttons -->
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary me-2">Save & Send</button>
<a href="{% url 'estimate_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<!-- Styling for Required Fields -->
<style>
  .has-error .form-control {
    border-color: #dc3545;
  }
</style>

<!-- Datepicker and Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
  $(document).ready(function () {
    $('.datepicker').datepicker({
      format: 'dd/mm/yyyy',
      autoclose: true,
      todayHighlight: true,
      startDate: new Date()
    });
  });

  // Include your JS logic here for calculations (already written in your existing code)
</script>

<!-- Client-Project Dynamic Dropdown Script -->
<script>
  $(document).ready(function () {
    $('.datepicker').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        todayHighlight: true
    });
});
  $(document).ready(function() {
    $('#id_client').change(function() {
      const clientId = $(this).val();
      const projectSelect = $('#id_project');

      if (clientId) {
        $.ajax({
          url: "{% url 'get_projects_by_client' %}",
          data: { client_id: clientId },
          success: function(data) {
            projectSelect.empty().append('<option value="">Select a Project</option>');
            data.forEach(function(project) {
              projectSelect.append(`<option value="${project.id}">${project.name}</option>`);
            });
          },
          error: function() {
            alert("Failed to load projects.");
          }
        });
      } else {
        projectSelect.empty().append('<option value="">Select a Project</option>');
      }
    });
  });
</script>

<script>
  function calculateEstimateTotals() {
    let subtotal = 0.00;

    // Loop through each item row
    document.querySelectorAll('#item-formset .estimate-item-form').forEach(row => {
      const unitCost = parseFloat(row.querySelector('.unit-cost')?.value || 0);
      const quantity = parseFloat(row.querySelector('.quantity')?.value || 0);
      const amount = unitCost * quantity;

      // Set amount field
      const amountField = row.querySelector('.amount-field');
      if (amountField) {
        amountField.value = amount.toFixed(2);
      }

      subtotal += amount;
    });

    // Show total before discount and tax
    document.getElementById('total-amount').textContent = subtotal.toFixed(2);

    // Apply Discount
    const discountPercent = parseFloat(document.getElementById('id_discount')?.value || 0);
    const discountAmount = (discountPercent / 100.0) * subtotal;
    const discountedTotal = subtotal - discountAmount;

    // Apply Tax
    let taxRate = 0.00;
    const taxSelect = document.getElementById('id_tax');
    if (taxSelect && taxSelect.options[taxSelect.selectedIndex]) {
      const match = taxSelect.options[taxSelect.selectedIndex].text.match(/(\d+(\.\d+)?)%/);
      if (match) {
        taxRate = parseFloat(match[1]);
      }
    }

    const taxAmount = discountedTotal * (taxRate / 100.0);
    const grandTotal = discountedTotal + taxAmount;

    // Update Summary Fields
    document.getElementById('discount-amount').value = discountAmount.toFixed(2);
    document.getElementById('tax-amount').value = taxAmount.toFixed(2);
    document.getElementById('grand-total').textContent = `Rs ${grandTotal.toFixed(2)}`;
  }

  function bindRowEvents(row) {
    row.querySelector('.unit-cost')?.addEventListener('input', calculateEstimateTotals);
    row.querySelector('.quantity')?.addEventListener('input', calculateEstimateTotals);
  }

  function setupFormsetActions() {
    const formset = document.getElementById('item-formset');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');

    formset.addEventListener('click', function (e) {
      const addBtn = e.target.closest('.add-item');
      const removeBtn = e.target.closest('.remove-item');

      // Add new item row
      if (addBtn) {
        e.preventDefault();
        const index = parseInt(totalForms.value);
        const templateRow = formset.querySelector('.estimate-item-form');
        const newRow = templateRow.cloneNode(true);

        newRow.setAttribute('data-form-index', index);

        newRow.querySelectorAll('input, select, textarea').forEach(input => {
          if (input.name) input.name = input.name.replace(/-\d+-/, `-${index}-`);
          if (input.id) input.id = input.id.replace(/-\d+-/, `-${index}-`);
          if (!input.classList.contains('amount-field')) input.value = '';
        });

        formset.appendChild(newRow);
        totalForms.value = index + 1;

        bindRowEvents(newRow);
        reindexItemRows();
        updateActionButtons();
        calculateEstimateTotals();
      }

      // Remove item row
      if (removeBtn) {
        e.preventDefault();
        const row = removeBtn.closest('tr');
        row.remove();

        const remainingRows = formset.querySelectorAll('.estimate-item-form');
        totalForms.value = remainingRows.length;

        reindexItemRows();
        updateActionButtons();
        calculateEstimateTotals();
      }
    });
  }

  function reindexItemRows() {
    document.querySelectorAll('#item-formset .estimate-item-form').forEach((row, idx) => {
      const indexCell = row.querySelector('td:first-child');
      if (indexCell) indexCell.textContent = idx + 1;
    });
  }

  function updateActionButtons() {
    const rows = document.querySelectorAll('#item-formset .estimate-item-form');
    rows.forEach((row, idx) => {
      const actionCell = row.querySelector('td:last-child');
      if (actionCell) {
        actionCell.innerHTML = idx === rows.length - 1
          ? `<a href="#" class="text-success add-item"><i class="fa fa-plus"></i></a>`
          : `<a href="#" class="text-danger remove-item"><i class="fa fa-trash"></i></a>`;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#item-formset .estimate-item-form').forEach(bindRowEvents);

    document.getElementById('id_discount')?.addEventListener('input', calculateEstimateTotals);
    document.getElementById('id_tax')?.addEventListener('change', calculateEstimateTotals);

    reindexItemRows();
    updateActionButtons();
    setupFormsetActions();
    calculateEstimateTotals();  // Initial total
  });
</script>

<script>
  $(document).ready(function () {
    $('.datepicker').datepicker({
      format: 'dd/mm/yyyy',
      autoclose: true,
      todayHighlight: true,
      startDate: new Date()
    });
  });
</script>


{% endblock %}
