{% extends "base.html" %}
{% load static %}
{% load project_filters %}
{% load widget_tweaks %}
{% load dict_extras %}
{% load crispy_forms_tags %}

{% block title %}Qubits HRMS | Projects{% endblock %}

{% block extra_head %}
<!-- Custom CSS -->
<style>
  input::placeholder {
    text-transform: uppercase;
  }

  .select-arrow-spacing {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: url("data:image/svg+xml;utf8,<svg fill='gray' height='12' viewBox='0 0 24 24' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") 
                no-repeat right 12px center;
    background-color: #fff;
    background-size: 12px;
    padding-right: 30px;
  }

  .search-input {
    height: 40px;
    min-width: 400px;
    padding: 5px 10px;
    border-radius: 4px;
  }

  .custom-select {
    height: 40px;
    font-size: 1rem;
  }

  @media (max-width: 768px) {
    .search-input {
      min-width: 120px;
    }
  }

  .ck-editor__editable_inline {
    min-height: 200px;
  }

  .ck.ck-editor_main > .ck-editor_editable:not(.ck-focused) {
    border-color: #ced4da;
  }

  /* Optional: Full width override if needed */
  .ck-editor {
    width: 100% !important;
  }

</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h3 class="page-title">Project Management</h3>
      <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
        <li class="breadcrumb-item active">Projects</li>
      </ul>
    </div>
    {% if user.role in 'superadmin company_owner' %}
    <div class="col-auto float-right ml-auto">
     <button class="btn add-btn" data-bs-toggle="modal" data-bs-target="#addProjectModal">
  <i class="fa fa-plus me-1"></i> Add New Project
</button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Display Messages -->
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-bs-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Search Filters -->
<div class="row mb-3">
  <div class="col-md-12">
    <form method="get">
      <div class="form-row">
        <div class="form-group col-md-3">
          <input type="text" name="project" class="form-control search-input" placeholder="Search by Project" value="{{ project_query }}">
        </div>
        <div class="form-group col-md-3">
          <input type="text" name="employee" class="form-control search-input" placeholder="Search by Employee" value="{{ employee_query }}">
        </div>
        <div class="form-group col-md-3">
          <select name="status" class="form-control custom-select-padding select-arrow-spacing">
            <option value="">Status</option>
            <option value="Not Started" {% if status_query == "Not Started" %}selected{% endif %}>Not Started</option>
            <option value="Ongoing" {% if status_query == "Ongoing" %}selected{% endif %}>Ongoing</option>
            <option value="Completed" {% if status_query == "Completed" %}selected{% endif %}>Completed</option>
          </select>
        </div>
        <div class="form-group col-md-3">
          <button type="submit" class="btn btn-primary w-100" style="height: 40px;">Search</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Project Table -->
<div class="row">
  <div class="col-md-12">
    <div class="table-responsive">
      <table class="table table-striped custom-table datatable">
        <thead>
          <tr>
            <th>SL.No.</th>
            <th>Project Name</th>
            <th>Client</th>
            <th>Team Leader</th>
            <th>Team Members</th>
            <th>Deadline</th>
            <th>Priority</th>
            <th>Status</th>
            {% if user.role in 'superadmin company_owner' %}
            <th class="text-center">Action</th>
            {% endif %}
          </tr>
        </thead>
<tbody>
  {% if projects %}
    {% for project in projects %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ project.name }}</td>
        <td>{{ project.client.client_name }}</td>
       <td>
                            <div class="team-leader-info" style="display: inline-flex; align-items: center; position: relative;">
    {% if project.team_leader.profile and project.team_leader.profile.profile_picture %}
        <img src="{{ project.team_leader.profile.profile_picture.url }}"
             title="{{ project.team_leader.first_name }} {{ project.team_leader.last_name }}"
             alt="Profile" width="30" height="30"
             style="border-radius: 50%; margin-right: 5px;">
    {% else %}
        <img src="{% static 'default-user.png' %}"
             alt="Default" width="30" height="30"
             style="border-radius: 50%; margin-right: 5px;">
    {% endif %}
    
    <span class="team-leader-name" style="display: none; white-space: nowrap;">
        {{ project.team_leader.first_name }} {{ project.team_leader.last_name }}
    </span>
</div>

                        </td>                          
                        <td>
                            {% for member in project.team_members.all %}
    {% if member.profile and member.profile.profile_picture %}
        <img src="{{ member.profile.profile_picture.url }}" alt="Photo" 
             title="{{ member.first_name }} {{ member.last_name }}"
             width="30" height="30" style="border-radius: 50%; margin: 2px;">
    {% else %}
        <img src="{% static 'default-user.png' %}" alt="Default" 
             title="{{ member.first_name }} {{ member.last_name }}"
             width="30" height="30" style="border-radius: 50%; margin: 2px;">
    {% endif %}
{% endfor %}

                        </td> 
        <td>{{ project.end_date }}</td>
        <td>
                            {% if user.role in 'superadmin company_owner' %}

                            <div class="dropdown action-label">
                                <a class="btn btn-white btn-sm btn-rounded dropdown-toggle" href="#" data-toggle="dropdown" aria-expanded="false">
                                    <i class="fa fa-dot-circle-o 
                                        {% if project.priority == 'low' %}text-success
                                        {% elif project.priority == 'medium' %}text-warning
                                        {% elif project.priority == 'high' %}text-danger
                                        {% endif %}
                                    "></i> {{ project.priority|title }}
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <form method="post" action="{% url 'update_priority' project.id %}">
                                        {% csrf_token %}
                                        <button class="dropdown-item" type="submit" name="priority" value="low">
                                            <i class="fa fa-dot-circle-o text-success"></i> Low
                                        </button>
                                        <button class="dropdown-item" type="submit" name="priority" value="medium">
                                            <i class="fa fa-dot-circle-o text-warning"></i> Medium
                                        </button>
                                        <button class="dropdown-item" type="submit" name="priority" value="high">
                                            <i class="fa fa-dot-circle-o text-danger"></i> High
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <div class="dropdown action-label">
                                <a class="btn btn-white btn-sm btn-rounded">
                                    <i class="fa fa-dot-circle-o 
                                        {% if project.priority == 'low' %}text-success
                                        {% elif project.priority == 'medium' %}text-warning
                                        {% elif project.priority == 'high' %}text-danger
                                        {% endif %}
                                    "></i> {{ project.priority|title }}
                                </a>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.role in 'superadmin company_owner' %}

                            <div class="dropdown action-label">
                                <a class="btn btn-white btn-sm btn-rounded dropdown-toggle" href="#" data-toggle="dropdown" aria-expanded="false">
                                    <i class="fa fa-dot-circle-o 
                                        {% if project.status == 'Completed' %}text-success
                                        {% elif project.status == 'Ongoing' %}text-warning
                                        {% else %}text-danger
                                        {% endif %}
                                    "></i> {{ project.status }}
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <form method="post" action="{% url 'update_status' project.id %}">
                                        {% csrf_token %}
                                        <button class="dropdown-item" type="submit" name="status" value="Not Started">
                                            <i class="fa fa-dot-circle-o text-danger"></i> Not Started
                                        </button>
                                        <button class="dropdown-item" type="submit" name="status" value="Ongoing">
                                            <i class="fa fa-dot-circle-o text-warning"></i> Ongoing
                                        </button>
                                        <button class="dropdown-item" type="submit" name="status" value="Completed">
                                            <i class="fa fa-dot-circle-o text-success"></i> Completed
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <div class="dropdown action-label">
                                <a class="btn btn-white btn-sm btn-rounded">
                                    <i class="fa fa-dot-circle-o 
                                        {% if project.status == 'Completed' %}text-success
                                        {% elif project.status == 'Ongoing' %}text-warning
                                        {% else %}text-danger
                                        {% endif %}
                                    "></i> {{ project.status }}
                                </a>
                            </div>
                            {% endif %}
                        </td>                                                                                                              
                        {% if user.role in 'superadmin company_owner' %}

                        <td class="text-center">
                            <div class="dropdown dropdown-action">
                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="material-icons">more_vert</i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="{% url 'project_view' project.id %}">
                                        <i class="fa fa-eye m-r-5"></i> View
                                    </a>
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProjectModal{{ project.id }}">
    <i class="fa fa-pencil m-r-5"></i> Edit
</a>

                                    <a class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal{{ project.id }}">
                                        <i class="fa fa-trash-o m-r-5"></i> Delete
                                    </a>
                                </div>
                            </div>
                        </td>
        {% endif %}
      </tr>

      <!-- Edit Modal -->
      <div class="modal custom-modal fade" id="editProjectModal{{ project.id }}" tabindex="-1" aria-labelledby="editProjectModalLabel{{ project.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <form method="post" action="{% url 'project_update' project.id %}" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="editProjectModalLabel{{ project.id }}">Edit Project: {{ project.name }}</h5>
                 <button type="button" class="close" data-bs-dismiss="modal" onclick="location.reload();">
    <span>&times;</span>
</button>
              </div>
              <div class="modal-body">
{% with edit_form=edit_forms|get_item:project.id %}
  {% if edit_form %}
    <div class="modal-body px-4 py-3">
      <div class="row">
        {% comment %}
        Render all fields except 'department' and 'status' first.
        After the 'client' field, insert 'department' field.
        Then render 'status' last.
        {% endcomment %}

        {% for field in edit_form %}
          {% if field.name not in 'department status' %}
            <div class="col-12 mb-3">
              <label class="form-label fw-semibold">{{ field.label|safe }}</label>

              {% if field.name == 'description' %}
                <!-- Description with CKEditor -->
                <!-- In your edit modal form (textarea): -->
<textarea
  id="ckeditor5-description-{{ project.id }}"
  name="description"
  class="form-control w-100"
  rows="8"
>{{ field.value|default_if_none:'' }}</textarea>
<div id="description-warning-{{ project.id }}" style="color: red; margin-top: 5px; display: none;"></div>

              {% else %}
                {{ field }}
              {% endif %}

              {% if field.errors %}
                <div class="text-danger small mt-1">{{ field.errors }}</div>
              {% endif %}
            </div>

            {% if field.name == 'client' %}
              <!-- Department field right after Client -->
              <div class="col-12 mb-3">
                <label class="form-label fw-semibold">{{ edit_form.department.label|safe }}</label>
                {{ edit_form.department }}
                {% if edit_form.department.errors %}
                  <div class="text-danger small mt-1">{{ edit_form.department.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}

        <!-- Status field last -->
        <div class="col-12 mb-3">
          <label class="form-label fw-semibold">{{ edit_form.status.label|safe }}</label>
          {{ edit_form.status }}
          {% if edit_form.status.errors %}
            <div class="text-danger small mt-1">{{ edit_form.status.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  {% else %}
    <p>Form not available.</p>
  {% endif %}
{% endwith %}

              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Update</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Delete Modal -->
      <div class="modal custom-modal fade" id="deleteProjectModal{{ project.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteProjectModalLabel{{ project.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{% url 'project_delete' project.id %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-header text-center">
            <h3>Delete Project</h3>
            <p>Are you sure you want to delete <strong>{{ project.name }}</strong>?</p>
          </div>
          <div class="modal-btn delete-action mt-4">
            <div class="row">
              <div class="col-6">
                <button type="submit" class="btn btn-outline-primary btn-block continue-btn">Delete</button>
              </div>
              <div class="col-6">
                <button type="button" class="btn btn-outline-secondary btn-block cancel-btn" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>


    {% endfor %}
  {% else %}
    <tr>
      <td colspan="9" class="text-center text-muted py-4">No Projects found.</td>
    </tr>
  {% endif %}
</tbody>

      </table>
    </div>
  </div>
</div>

<!-- Add Project Modal -->
<div class="modal custom-modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addProjectModalLabel">Add New Project</h5>
          <button type="button" class="close" data-bs-dismiss="modal" onclick="location.reload();">
            <span>&times;</span>
          </button>
        </div>

        <div class="modal-body px-4 py-3">
          <div class="row">
            {% comment %}
            Render all fields except 'department' and 'status' first.
            After the 'client' field, insert 'department' field.
            Then render 'status' last.
            {% endcomment %}

            {% for field in form %}
              {% if field.name not in 'department status' %}
                <div class="col-12 mb-3">
                  <label class="form-label fw-semibold">{{ field.label|safe }}</label>

                  {% if field.name == 'description' %}
                    <!-- Description with CKEditor -->
                    <textarea id="ckeditor5-description" name="description" class="form-control w-100" rows="8">{{ field.value|default_if_none:'' }}</textarea>
                    <div id="description-warning" style="color: red; margin-top: 5px; display: none;"></div>
                  {% else %}
                    {{ field }}
                  {% endif %}

                  {% if field.errors %}
                    <div class="text-danger small mt-1">{{ field.errors }}</div>
                  {% endif %}
                </div>

                {% if field.name == 'client' %}
                  <!-- Department field right after Client -->
                  <div class="col-12 mb-3">
                    <label class="form-label fw-semibold">{{ form.department.label|safe }}</label>
                    {{ form.department }}
                    {% if form.department.errors %}
                      <div class="text-danger small mt-1">{{ form.department.errors }}</div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endif %}
            {% endfor %}

            <!-- Status field last -->
            <div class="col-12 mb-3">
              <label class="form-label fw-semibold">{{ form.status.label|safe }}</label>
              {{ form.status }}
              {% if form.status.errors %}
                <div class="text-danger small mt-1">{{ form.status.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="modal-footer bg-light px-4 py-2">
          <button type="submit" name="add_project" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const fileInputs = document.querySelectorAll('input[name="file_upload"]'); // get all file inputs

  fileInputs.forEach(function (fileInput) {
    // Find parent div of file field
    const parentDiv = fileInput.closest(".mb-3") || fileInput.parentNode;

    // Create error container
    let errorMsg = document.createElement("div");
    errorMsg.className = "text-danger small mt-1";
    errorMsg.style.display = "none";
    parentDiv.appendChild(errorMsg);

    fileInput.addEventListener("change", function () {
      errorMsg.style.display = "none";
      errorMsg.textContent = "";

      const file = this.files[0];
      if (!file) return;

      const allowedTypes = ["application/pdf", "image/jpeg", "image/png"];
      const maxSize = 5 * 1024 * 1024; // 5MB

      if (!allowedTypes.includes(file.type)) {
        errorMsg.textContent = "Only PDF, JPG, JPEG, and PNG files are allowed.";
        errorMsg.style.display = "block";
        this.value = ""; // reset invalid file
        return;
      }

      if (file.size > maxSize) {
        errorMsg.textContent = "File size must be less than 5 MB.";
        errorMsg.style.display = "block";
        this.value = "";
        return;
      }
    });
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    $('#addTaxModal').on('hidden.bs.modal', function () {
        // Fully reset form fields
        this.querySelector('form').reset();

        // Optional: Remove any validation errors if shown
        $(this).find('.is-invalid').removeClass('is-invalid');
        $(this).find('.invalid-feedback').remove();

        // Force re-render if needed (reload the modal content from DOM)
        $(this).html($(this).html());
    });
});
</script>
<!-- ✅ CKEditor 5 CDN -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>

<!-- ✅ CKEditor Initialization -->
<script>
let editorInstance;

function initCKEditor() {
  const el = document.querySelector('#ckeditor5-description');
  if (el && !el.classList.contains('ck-editor-initialized')) {
    ClassicEditor.create(el)
      .then(editor => {
        editorInstance = editor;
        el.classList.add('ck-editor-initialized');
      })
      .catch(error => console.error(error));
  }
}

function destroyCKEditor() {
  if (editorInstance) {
    editorInstance.destroy().then(() => {
      document.querySelector('#ckeditor5-description').classList.remove('ck-editor-initialized');
      editorInstance = null;
    });
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('addProjectModal');
  const warningDiv = modal.querySelector('#description-warning');
  const textarea = modal.querySelector('#ckeditor5-description');

  modal.addEventListener('shown.bs.modal', initCKEditor);

  modal.addEventListener('hidden.bs.modal', function () {
    destroyCKEditor();
    modal.querySelector('form').reset();
    warningDiv.style.display = 'none';  // Hide warning on modal close/reset
    warningDiv.textContent = '';        // Clear any previous message
  });

  modal.querySelector('form').addEventListener('submit', function (e) {
    if (editorInstance) {
      const data = editorInstance.getData().trim();
      textarea.value = data;

      if (!data) {
        e.preventDefault();
        warningDiv.textContent = "⚠️ Please fill out the description field.";
        warningDiv.style.display = 'block';
        textarea.focus();
      } else {
        warningDiv.style.display = 'none';
        warningDiv.textContent = '';
      }
    }
  });
});
document.addEventListener('DOMContentLoaded', function () {
  // Store all editor instances by project id
  const editorInstances = {};

  // Function to init CKEditor on a given textarea
  function initCKEditor(id) {
    const el = document.getElementById(id);
    if (el && !el.classList.contains('ck-editor-initialized')) {
      ClassicEditor.create(el)
        .then(editor => {
          editorInstances[id] = editor;
          el.classList.add('ck-editor-initialized');
        })
        .catch(error => console.error(error));
    }
  }

  // Function to destroy CKEditor on a given textarea
  function destroyCKEditor(id) {
    if (editorInstances[id]) {
      editorInstances[id].destroy().then(() => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('ck-editor-initialized');
        }
        delete editorInstances[id];
      });
    }
  }

  // Initialize/destroy editor on each edit modal shown/hidden event
  document.querySelectorAll('[id^="editProjectModal"]').forEach(modal => {
    modal.addEventListener('shown.bs.modal', () => {
      const projectId = modal.id.replace('editProjectModal', '');
      initCKEditor(`ckeditor5-description-${projectId}`);
    });

    modal.addEventListener('hidden.bs.modal', () => {
      const projectId = modal.id.replace('editProjectModal', '');
      destroyCKEditor(`ckeditor5-description-${projectId}`);

      // Also reset form and hide warnings if needed
      const form = modal.querySelector('form');
      if (form) form.reset();

      const warningDiv = modal.querySelector(`#description-warning-${projectId}`);
      if (warningDiv) {
        warningDiv.style.display = 'none';
        warningDiv.textContent = '';
      }
    });

    // Add submit event listener for validation per modal form
    const form = modal.querySelector('form');
    if (form) {
      form.addEventListener('submit', e => {
        const projectId = modal.id.replace('editProjectModal', '');
        const editor = editorInstances[`ckeditor5-description-${projectId}`];
        const textarea = document.getElementById(`ckeditor5-description-${projectId}`);
        const warningDiv = modal.querySelector(`#description-warning-${projectId}`);

        if (editor) {
          const data = editor.getData().trim();
          textarea.value = data;

          if (!data) {
            e.preventDefault();
            if (warningDiv) {
              warningDiv.textContent = "⚠️ Please fill out the description field.";
              warningDiv.style.display = 'block';
            }
            textarea.focus();
          } else if (warningDiv) {
            warningDiv.style.display = 'none';
            warningDiv.textContent = '';
          }
        }
      });
    }
  });
});

</script>


{% endblock %}
