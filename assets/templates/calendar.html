{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold">Events</h2>
            <small class="text-muted">Dashboard / Events</small>
        </div>
        
        <button class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="fas fa-plus"></i> Add Event
        </button>
        
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div id="calendar" style="min-height: 600px;"></div>
        </div>
    </div>
</div>
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 rounded-3 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addEventModalLabel">Add Event</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="eventForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="eventTitle" class="form-label">Event Name</label>
            <input type="text" class="form-control" id="eventTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="eventStart" class="form-label">Start Date & Time</label>
            <input type="datetime-local" class="form-control" id="eventStart" name="start_time" required>
          </div>
          <div class="mb-3">
            <label for="eventEnd" class="form-label">End Date & Time</label>
            <input type="datetime-local" class="form-control" id="eventEnd" name="end_time" required>
          </div>
          <div class="mb-3">
            <label for="eventCategory" class="form-label">Category</label>
            <input type="text" class="form-control" id="eventCategory" name="category" required>
          </div>
          <div class="mb-3">
            <label for="eventColor" class="form-label">Event Color</label>
            <input type="color" class="form-control form-control-color" id="eventColor" name="color" value="#3788d8">
          </div>
          <button type="submit" class="btn btn-primary w-100 rounded-pill">Add Event</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 rounded-3 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="eventDetailsModalLabel">Event Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Title:</strong> <span id="eventDetailsTitle"></span></p>
                <p><strong>Start:</strong> <span id="eventDetailsStart"></span></p>
                <p><strong>End:</strong> <span id="eventDetailsEnd"></span></p>
                <p><strong>Category:</strong> <span id="eventDetailsCategory"></span></p>
                <p><strong>Color:</strong> <span id="eventDetailsColor" style="width: 20px; height: 20px; display: inline-block;"></span></p>
                <div id="eventDetailsActions" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: [
                {% for event in events %}
                {
                    title: "{{ event.title|escapejs }}",
                    start: "{{ event.start_time|date:'Y-m-d\\TH:i' }}",
                    end: "{{ event.end_time|date:'Y-m-d\\TH:i' }}",
                    color: "{{ event.color|default:'#3788d8' }}",
                    id: "{{ event.id }}",
                    extendedProps: {
                        category: "{{ event.category|default:''|escapejs }}"
                    }
                },
                {% endfor %}
            ],
            eventTimeFormat: {
                hour: 'numeric',
                minute: '2-digit',
                meridiem: true
            },
            height: "auto",
            nowIndicator: true,
            eventClick: function(info) {
                showEventDetails(info.event);
            }
        });

        calendar.render();

        // Handle form submit
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const form = this;
            const formData = new FormData(form);

            fetch("{% url 'add_event' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    calendar.addEvent({
                        title: data.event.title,
                        start: data.event.start_time,
                        end: data.event.end_time,
                        color: data.event.color
                    });

                    bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
                    form.reset();
                } else {
                    alert(data.message || 'Failed to add event.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding event.');
            });
        });
    });

    function showEventDetails(event) {
        const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
        document.getElementById('eventDetailsTitle').textContent = event.title;
        document.getElementById('eventDetailsStart').textContent = event.start.toLocaleString();
        document.getElementById('eventDetailsEnd').textContent = event.end ? event.end.toLocaleString() : 'N/A';
        document.getElementById('eventDetailsCategory').textContent = event.extendedProps.category || 'N/A';
        document.getElementById('eventDetailsColor').style.backgroundColor = event.color;

        const editUrl = `/calendar/edit_event/${event.id}/`;
        const deleteUrl = `/calendar/delete_event/${event.id}/`;

        document.getElementById('eventDetailsActions').innerHTML = `
            <a href="${editUrl}" class="btn btn-warning me-2">Edit</a>
            <button onclick="confirmDeleteEvent(${event.id})" class="btn btn-danger">Delete</button>
        `;
        modal.show();
    }

    function confirmDeleteEvent(eventId) {
        if (confirm("Are you sure you want to delete this event?")) {
            fetch(`/calendar/delete_event/${eventId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Event deleted successfully.');
                    location.reload();
                } else {
                    alert('Error deleting event.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting event.');
            });
        }
    }
</script>
{% endblock %}
