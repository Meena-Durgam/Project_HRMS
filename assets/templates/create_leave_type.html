{% extends 'base.html' %}
{% block title %}Qubits HRMS | Leave Settings{% endblock %}

{% load leave_tags %}

{% block content %}
<style>
/* Hide default arrow */

.select-arrow-spacing {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;

  background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='30' viewBox='0 0 24 24' width='30' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;

  /* ðŸ‘‡ Arrow spacing from the right */
  background-position: right 14px center;

  /* ðŸ‘‡ Add right padding so text doesn't collide with the arrow */
  padding-right: 38px;

  background-size: 24px;
}
</style>
<!-- âœ… Add red star CSS for required fields -->
<style>
  .entry-selector-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }

  .entry-input {
    width: 60px;
    padding: 4px 8px;
    font-size: 14px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 2px;
    box-shadow: none;
  }

  .entry-input::-webkit-outer-spin-button,
  .entry-input::-webkit-inner-spin-button {
    opacity: 1;
  }

  .entry-input[type="number"] {
    appearance: textfield;
    -moz-appearance: textfield;
  }
</style>
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title">Leave</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active">Leave</li>
            </ul>
        </div>
        <div class="col-auto d-flex align-items-center">
            <button class="btn btn-primary rounded-pill add-btn" data-toggle="modal" data-target="#leaveTypeModal">
                <i class="fa fa-plus me-1"></i>  Add Leave Type
            </button>
        </div>
    </div>
</div>

{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}
<form method="get" class="row g-2 mb-3 align-items-stretch">
    <div class="col-md-4">
        <input type="text" name="search" class="form-control h-100"
               placeholder="Enter Leave Type"
               value="{{ search_query }}">
    </div>
    <div class="col-md-4">
        <select name="eligibility" class="form-control custom-select-padding select-arrow-spacing h-100">
            <option value="">Search by Eligibility</option>
            <option value="all" {% if eligibility_filter == 'all' %}selected{% endif %}>All Employees</option>
            <option value="male" {% if eligibility_filter == 'male' %}selected{% endif %}>Male Employees</option>
            <option value="female" {% if eligibility_filter == 'female' %}selected{% endif %}>Female Employees</option>
        </select>
    </div>
    <div class="col-md-4">
        <button type="submit" class="btn btn-primary w-100 h-100">Search</button>
    </div>
</form>
<form method="get" class="entry-selector-wrapper mb-2 d-flex align-items-center">
  <!-- Keep search and filter values -->
  <input type="hidden" name="search" value="{{ search_query }}">
  <input type="hidden" name="eligibility" value="{{ eligibility_filter }}">

  <label for="per_page" class="me-2">Show
    <select id="per_page" name="page_size" class="form-select form-select-sm w-auto"
          onchange="this.form.submit()">
      <option value="5" {% if page_size == 5 %}selected{% endif %}>5</option>
      <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
      <option value="15" {% if page_size == 15 %}selected{% endif %}>15</option>
      <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
  </select>
   entries
  </label>
</form>


<div class="table-responsive">
                <table class="table table-striped custom-table mb-0 datatable">
                    <thead>
                        <tr>
                            <th>SL. No.</th>
                            <th>Leave Type</th>
                            <th>Eligibility</th>
                            <th>Monthly Accrual</th>
                            <th>Carry Forward</th>
                            <th>Encashment</th>
                            <th>Default Days</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
    {% if leave_types %}
        {% for lt in leave_types %}
            <tr>
                <td class="text-center">{{ forloop.counter0|add:leave_types.start_index }}</td>
                <td>{{ lt.name }}</td>
                <td>{{ lt.get_eligibility_display }}</td>
                <td class="text-center">{{ lt.monthly_accrual }}</td>
                <td class="text-center">{{ lt.get_carry_forward_display }}</td>
                <td class="text-center">{{ lt.get_encashment_display }}</td>
                <td class="text-center">{{ lt.default_days }}</td>
                <td class="text-center">
                    <div class="dropdown dropdown-action">
                        <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="material-icons">more_vert</i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editModal{{ lt.id }}">
                                <i class="fa fa-pencil m-r-5"></i> Edit
                            </a>
                            <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteModal{{ lt.id }}">
                                <i class="fa fa-trash-o m-r-5"></i> Delete
                            </a>
                            <a class="dropdown-item text-primary" href="#" 
                               data-bs-toggle="modal" 
                               data-bs-target="#assignLeaveModal{{ lt.id }}">
                                <i class="fa fa-user-plus m-r-5"></i> Assign Leave Type
                            </a>
                        </div>
                    </div>
                </td>
            </tr>

            <!-- âœ… Assign Modal -->
            <div class="modal custom-modal fade" id="assignLeaveModal{{ lt.id }}" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content p-4 rounded-4 text-center">
                        <div class="modal-body">
                            <h3 class="fw-semibold mb-3">Assign Leave Balances</h3>
                            <p class="text-muted">
                                Are you sure you want to assign <strong>{{ lt.name }}</strong>
                                to all eligible employees?
                            </p>
                            <form method="post" action="{% url 'assign_leave_balances' lt.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-primary">Confirm</button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- âœ… Edit Modal -->
            <div class="modal custom-modal fade" id="editModal{{ lt.id }}" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <form method="post" action="{% url 'edit_leave_type' lt.id %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Leave Type</h5>
                               <button type="button" class="close" data-bs-dismiss="modal" onclick="location.reload();">
    <span>&times;</span>
</button> 
                            </div>
                            <div class="modal-body">
                                {% with edit_forms|dict_get:lt.id as edit_form %}
                                    {{ edit_form.as_p }}
                                {% endwith %}
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- âœ… Delete Modal -->
            <div class="modal custom-modal fade" id="deleteModal{{ lt.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content text-center p-4 rounded-4">
                        <div class="modal-body">
                            <h3 class="mb-2 fw-semibold">Delete Leave Type</h3>
                            <p class="text-muted mb-4" style="font-size: 14px;">Are you sure want to delete?</p>
                            <form method="post" action="{% url 'delete_leave_type' lt.id %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-6">
                                        <button type="submit" class="btn btn-outline-primary w-100 continue-btn">Delete</button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-secondary w-100 cancel-btn" data-bs-dismiss="modal">Cancel</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <tr>
            <td colspan="8" class="text-center align-middle py-4">
                <span class="text-muted">No leave types have been created yet.</span>
            </td>
        </tr>
    {% endif %}
</tbody>

    </table>
          
</div>

<!-- âœ… Add Leave Type Modal -->
<div class="modal custom-modal fade" id="leaveTypeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Leave Type</h5>
                   <button type="button" class="close" data-bs-dismiss="modal" onclick="location.reload();">
    <span>&times;</span>
</button> 
                </div>
                <div class="modal-body">
                    {{ form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center">
    <div>
        {% with start=leave_types.start_index|default_if_none:0 end=leave_types.end_index|default_if_none:0 %}
            Showing {{ start }} to {{ end }} of {{ leave_types.paginator.count }} entries
        {% endwith %}
    </div>

    <nav>
        <ul class="pagination mb-0">
            {% if leave_types.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ leave_types.previous_page_number }}&page_size={{ page_size }}&search={{ search_query }}&eligibility={{ eligibility_filter }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for i in leave_types.paginator.page_range %}
                <li class="page-item {% if i == leave_types.number %}active{% endif %}">
                    <a class="page-link" href="?page={{ i }}&page_size={{ page_size }}&search={{ search_query }}&eligibility={{ eligibility_filter }}">{{ i }}</a>
                </li>
            {% endfor %}

            {% if leave_types.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ leave_types.next_page_number }}&page_size={{ page_size }}&search={{ search_query }}&eligibility={{ eligibility_filter }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- âœ… Bootstrap JS (v4.6) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- âœ… Reset ANY modal form when closed -->
<script>
$(document).on('hidden.bs.modal', '.modal', function () {
    const form = $(this).find('form');
    if (form.length) {
        form[0].reset();
    }
});
$('#leaveTypeModal').on('hidden.bs.modal', function () {
      $(this).find('form')[0].reset();
  });
</script>

{%Â endblockÂ %}
