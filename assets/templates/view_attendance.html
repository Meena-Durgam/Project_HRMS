{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-8">
  <div>
    <h4 class="mb-0">Employees</h4>
    <small class="text-muted">Dashboard / Attendance</small>
  </div>
  <div>
      <button class="btn btn-light border dropdown-toggle" type="button" data-bs-toggle="dropdown">
    <i class="fas fa-file-export me-1"></i> Export
  </button>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="{% url 'export_attendance_csv' %}">Export as CSV</a></li>
    <li><a class="dropdown-item" href="{% url 'export_attendance_pdf' %}">Export as PDF</a></li>
  </ul>

    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#attendanceReportModal">
  <i class="fas fa-file-pdf me-1"></i> Report
  
</button>
<button class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#attendanceModal">Mark Attendance</button>
  </div>
</div>
  <div class="card shadow-sm rounded-4 p-4 transparent-card">
    <h2 class="text-center fw-bold mb-4">Attendance Records</h2>

    <!-- Professional Summary Cards -->
    <div class="row g-4 mb-5">
      <div class="col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body text-center">
            <div class="mb-2">
              <i class="bi bi-collection-fill fs-2 text-primary"></i> <!-- Total Records -->
            </div>
            <h6 class="text-muted">Total Records</h6>
            <h4 class="fw-semibold">{{ total_records }}</h4>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body text-center">
            <div class="mb-2">
              <i class="bi bi-check-circle-fill fs-2 text-success"></i> <!-- Present -->
            </div>
            <h6 class="text-muted">Present</h6>
            <h4 class="fw-semibold">{{ present_count }}</h4>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body text-center">
            <div class="mb-2">
              <i class="bi bi-x-circle-fill fs-2 text-danger"></i> <!-- Absent -->
            </div>
            <h6 class="text-muted">Absent</h6>
            <h4 class="fw-semibold">{{ absent_count }}</h4>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body text-center">
            <div class="mb-2">
              <i class="bi bi-pencil-square fs-2 text-warning"></i> <!-- Leave -->
            </div>
            <h6 class="text-muted">Leave</h6>
            <h4 class="fw-semibold">{{ leave_count }}</h4>
          </div>
        </div>
      </div>
    </div>
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

    <!-- Filters -->
    <form method="get" class="row g-3 mb-4">
      <div class="col-md-4">
        <input type="date" name="start_date" class="form-control" value="{{ start_date|default_if_none:'' }}">
      </div>
      <div class="col-md-4">
        <input type="date" name="end_date" class="form-control" value="{{ end_date|default_if_none:'' }}">
      </div>
      <div class="col-md-4 d-flex gap-2">
        <input type="text" name="username" class="form-control" placeholder="Search username" value="{{ request.GET.username }}">
        <button class="btn btn-dark">Filter</button>
        <a href="{% url 'export_attendance_csv' %}" class="btn btn-outline-secondary">CSV</a>
      </div>
    </form>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>Employee</th>
            <th>Date</th>
            <th>Status</th>
            <th>Check In</th>
            <th>Check Out</th>
            <th>Location</th>
            <th>Image</th>
            {% if user.role == 'superadmin' %}
              <th>Action</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for record in records %}
            <tr>
              <td>{{ record.employee.username }}</td>
              <td>{{ record.date|date:"M d, Y" }}</td>
              <td>{{ record.status }}</td>
              <td>
                {% if record.check_in_time %}
                  {{ record.check_in_time|time:"h:i A" }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if record.check_out_time %}
                  {{ record.check_out_time|time:"h:i A" }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if record.location %}
                  <a href="https://maps.google.com?q={{ record.location }}" target="_blank">{{ record.location }}</a>
                {% else %}N/A{% endif %}
              </td>
              <td>
                {% if record.image %}
                  <img src="{{ record.image.url }}" width="50" height="50" class="rounded-circle shadow-sm object-fit-cover">
                {% else %}N/A{% endif %}
              </td>
              {% if user.role == 'superadmin' %}
                <td>
                  <a href="{% url 'delete_attendance' record.pk %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">Delete</a>
                </td>
              {% endif %}
            </tr>
          {% empty %}
            <tr><td colspan="8" class="text-center">No records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ... Existing Summary Cards Code ... -->

<!-- Attendance Matrix -->
<div class="card shadow-sm rounded-4 p-4 mb-5">
  <h4 class="fw-bold mb-3">Attendance Matrix</h4>
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Employee</th>
          {% for date in matrix_dates %}
            <th>{{ date|date:"M d" }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for employee, statuses in matrix_data.items %}
          <tr>
            <td>{{ employee }}</td>
            {% for status in statuses %}
              <td>
                {% if status == "Present" %}
                  <span class="text-success fw-bold">✔</span>
                {% elif status == "Absent" %}
                  <span class="text-danger fw-bold">✖</span>
                {% elif status == "Leave" %}
                  <span class="text-warning fw-bold">⏸</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


    <!-- Pagination -->
    <div class="d-flex justify-content-between">
      <div>
        Showing {{ records.start_index }} to {{ records.end_index }} of {{ records.paginator.count }} records
      </div>
      <div>
        {% if records.has_previous %}
          <a href="?page=1" class="btn btn-secondary">First</a>
          <a href="?page={{ records.previous_page_number }}" class="btn btn-secondary">Previous</a>
        {% endif %}
        {% if records.has_next %}
          <a href="?page={{ records.next_page_number }}" class="btn btn-secondary">Next</a>
          <a href="?page={{ records.paginator.num_pages }}" class="btn btn-secondary">Last</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Optional styling -->
<style>
  .card {
    background-color: rgba(255, 255, 255, 0.5) !important;  /* Make card background semi-transparent */
    color: #000;  /* Ensures text is black for better visibility */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);  /* Subtle shadow for depth */
  }

  .btn {
    font-size: 14px;
  }

  .table th, .table td {
    vertical-align: middle;
  }

  /* Responsive Design */
  @media screen and (max-width: 768px) {
    .btn, .form-control, .table {
      font-size: 14px;
    }
    .table th, .table td {
      padding: 0.5rem;
    }
  }
</style>

<!-- Bootstrap Icons CDN (include in base.html head if not already) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}
