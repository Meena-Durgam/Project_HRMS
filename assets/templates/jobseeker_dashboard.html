{% extends 'base_job.html' %}
{% load static %}

{% block extra_css %}
<style>
  .job-card {
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    border: none;
    padding: 18px;
    background: white;
    transition: transform 0.2s ease;
  }
  .job-card:hover { transform: translateY(-3px); }
  .job-card h5 { font-weight: 600; color: #0066ff; font-size: 1.05rem; margin-bottom: 10px; }
  .job-meta { font-weight: bold; color: #333; }
  .job-type {
    display: inline-block; background-color: #f5f5f5; color: #333;
    border-radius: 6px; padding: 2px 8px; font-size: 0.8rem; margin-left: 5px;
  }
  .job-footer {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 15px; font-size: 0.85rem;
  }
  .btn-view {
    border: 1px solid #0066ff; color: #0066ff; background: transparent;
    padding: 4px 10px; border-radius: 6px; font-size: 0.85rem;
    display: flex; align-items: center; gap: 5px;
  }
  .btn-view:hover { background: #0066ff; color: white; }

  .countdown { font-size: 0.85rem; font-weight: 600; color: #ff5722; }
  .badge-status {
    padding: 4px 8px; font-size: 0.75rem; border-radius: 5px; font-weight: 600;
  }
  .badge-upcoming { background: #e3f2fd; color: #0d6efd; }
  .badge-today { background: #fff3cd; color: #856404; }
  .badge-missed { background: #f8d7da; color: #721c24; }
  
  /* Real-time countdown styles */
  .realtime-countdown {
    font-size: 0.8rem;
    font-weight: 600;
    color: #ff5722;
    background: #fff3e0;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    margin-top: 5px;
  }
  
  .countdown-urgent {
    color: #d32f2f;
    background: #ffebee;
    animation: pulse 1s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
</style>
{% endblock %}

{% block title %}Jobseeker Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}

  {% if is_profile_incomplete %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center">
      <div><strong>ðŸ‘‹ Welcome!</strong> Your profile is incomplete. Please update it to get better job recommendations.</div>
      <a href="{% url 'profile_view' %}" class="btn btn-sm btn-outline-primary">Complete Profile</a>
    </div>
  {% endif %}

  <div class="text-center mb-5">
    <h2 class="display-5 font-weight-semibold text-primary">
      Welcome, {{ profile.user.get_full_name }}! ðŸ‘‹
    </h2>
    <p class="text-muted">Here's a snapshot of your job hunt progress and opportunities.</p>
  </div>

  <!-- âœ… Stats Section -->
  <div class="row g-4 mb-5">
    <div class="col-md-6 col-lg-3">
      <div class="card shadow border-0 text-center h-100">
        <div class="card-body">
          <i class="fas fa-briefcase fa-2x text-primary mb-3"></i>
          <h6>Applied Jobs</h6>
          <h3 class="font-weight-bold">{{ applied_jobs_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="card shadow border-0 text-center h-100">
        <div class="card-body">
          <i class="fas fa-bookmark fa-2x text-warning mb-3"></i>
          <h6>Saved Jobs</h6>
          <h3 class="font-weight-bold">{{ saved_jobs_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="card shadow border-0 text-center h-100">
        <div class="card-body">
          <i class="fas fa-calendar-check fa-2x text-success mb-3"></i>
          <h6>Interview Calendar</h6>
          <h3 class="font-weight-bold" id="interview-count">{{ all_scheduled_interviews|length }}</h3>
          <small class="text-muted">Scheduled Interviews</small>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="card shadow border-0 text-center h-100">
        <div class="card-body">
          <i class="fas fa-user-check fa-2x text-danger mb-3"></i>
          <h6>Profile Completion</h6>
          <h3 class="font-weight-bold">{{ profile_completion }}%</h3>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-danger" style="width: {{ profile_completion }}%;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Next Interview Card -->


  <!-- âœ… Upcoming Interviews -->
  {% if upcoming_interviews %}
<div class="mb-5">
  <h4 class="mb-4 text-primary">ðŸ—“ Upcoming Interviews</h4>
  <div class="list-group">
    {% for interview in upcoming_interviews %}
      <div class="list-group-item shadow-sm rounded mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1 text-dark">
              {{ interview.application.job.title }}
              <small class="text-muted ml-2">| Round {{ interview.round_number }} - {{ interview.round_type }}</small>
            </h5>
            <p class="mb-1 text-muted">
              {{ interview.interview_mode }}
              {% if interview.interview_mode == "Online" and interview.meeting_link %}
                â€“ <a href="{{ interview.meeting_link }}" target="_blank" class="btn btn-sm btn-outline-primary ml-2">Join Meeting</a>
              {% elif interview.interview_mode == "Offline" and interview.venue_details %}
                â€“ <span class="badge badge-secondary ml-2">{{ interview.venue_details }}</span>
              {% endif %}
            </p>
          </div>
          <div class="text-right">
            <small class="text-muted d-block">{{ interview.interview_date }} at {{ interview.interview_time }}</small>

            {% if interview.interview_date == today %}
              <span class="badge badge-status badge-today">Today</span>
            {% elif interview.interview_date > today %}
              <span class="badge badge-status badge-upcoming">Upcoming</span>
            {% else %}
              <span class="badge badge-status badge-missed">Missed</span>
            {% endif %}

            <div class="realtime-countdown mt-1" data-interview-id="{{ interview.id }}"
                 data-date="{{ interview.interview_date }}"
                 data-time="{{ interview.interview_time }}">
              <i class="fas fa-clock"></i>
              <span id="countdown-text-{{ interview.id }}">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

  <!-- âœ… Latest Jobs -->
 <div class="mb-5">
  <h4 class="mb-4 text-primary">ðŸ“¢ Latest Jobs</h4>
  <div class="row g-4">
    {% for job in latest_jobs %}
      <div class="col-md-6 col-lg-4">
        <div class="job-card">
          <h5>{{ job.title }}</h5>
          <p><span class="job-meta">Company:</span> {{ job.company.name }}</p>
          <p><span class="job-meta">Location:</span> {{ job.location }}</p>
          <p><span class="job-meta">Job Type:</span><span class="job-type">{{ job.job_type }}</span></p>
          <p><span class="job-meta">Last date:</span> {{ job.expired_date|date:"M d, Y" }}</p>
          <div class="job-footer d-flex justify-content-between">
            <a href="{% url 'job_detail' job.id %}" class="btn-view"><i class="bi bi-eye"></i> View Job</a>
            <form method="post" action="{% url 'apply_job' job.id %}">
              {% csrf_token %}
             <a href="{% url 'job_detail' job.id %}" class="btn btn-outline-primary btn-sm shadow-sm" data-bs-toggle="tooltip" title="Apply for this job">
               <i class="bi bi-check2-circle"></i> Apply
             </a>

            </form>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12"><p>No new jobs available at the moment.</p></div>
    {% endfor %}
  </div>
</div>

  <!-- âœ… Recommended Jobs -->
  <div>
    <h4 class="mb-4 text-primary">ðŸŽ¯ Recommended Jobs</h4>
    <div class="row g-4">
      {% if recommended_jobs %}
        {% for job in recommended_jobs %}
          <div class="col-md-6 col-lg-4">
            <div class="job-card">
              <h5>{{ job.title }}</h5>
              <p><span class="job-meta">Company:</span> {{  job.company.name }}</p>
              <p><span class="job-meta">Location:</span> {{ job.location }}</p>
              <p><span class="job-meta">Job Type:</span> <span class="job-type">{{ job.job_type }}</span></p>
              <p><span class="job-meta">Last date:</span> {{ job.expired_date|date:"M d, Y" }}</p>
              <div class="job-footer">
                <a href="{% url 'job_detail' job.id %}" class="btn-view"><i class="bi bi-eye"></i> View Job</a>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col-12"><p>No recommended jobs found.</p></div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Bootstrap & jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Calendar CSS -->
<style>
.calendar {
  font-family: Arial, sans-serif;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
}

.calendar-nav {
  display: flex;
  gap: 10px;
}

.calendar-nav button {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.calendar-nav button:hover {
  background: #0056b3;
}

.calendar-title {
  font-size: 18px;
  font-weight: bold;
  color: #333;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #ddd;
  border-radius: 8px;
  overflow: hidden;
}

.calendar-day-header {
  background: #f8f9fa;
  padding: 10px;
  text-align: center;
  font-weight: bold;
  color: #666;
  font-size: 12px;
}

.calendar-day {
  background: white;
  min-height: 80px;
  padding: 8px;
  position: relative;
  cursor: pointer;
  transition: background-color 0.2s;
}

.calendar-day:hover {
  background: #f8f9fa;
}

.calendar-day.other-month {
  background: #f5f5f5;
  color: #999;
}

.calendar-day.today {
  background: #e3f2fd;
  font-weight: bold;
}

.calendar-day.has-interview {
  background: #fff3e0;
  border-left: 3px solid #ff9800;
}

.calendar-day.has-interview.today {
  background: #fff3e0;
  border-left: 3px solid #ff9800;
}

.day-number {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 4px;
}

.interview-indicator {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 8px;
  height: 8px;
  background: #ff5722;
  border-radius: 50%;
}

.interview-details {
  font-size: 10px;
  color: #666;
  margin-top: 4px;
  line-height: 1.2;
}

.interview-time {
  font-weight: bold;
  color: #ff5722;
}

.interview-job {
  color: #333;
  font-weight: 500;
}

.interview-round {
  color: #666;
  font-size: 9px;
}

.calendar-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 15px;
  font-size: 12px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

.legend-interview {
  background: #ff9800;
}

.legend-today {
  background: #2196f3;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Real-time Countdown JavaScript -->
<script>
// Interview data from Django template
const interviews = {{ interviews_json|safe }};
const calendarInterviews = {{ calendar_interviews_json|safe }};

document.addEventListener('DOMContentLoaded', function () {

    function updateCountdown(interviewId, date, time) {
        const countdownEl = document.getElementById(countdown-text-${interviewId});
        const countdownContainer = document.getElementById(countdown-${interviewId});
        if (!countdownEl || !date || !time) return;

        const now = new Date();
        const interviewTime = new Date(${date}T${time});
        const diff = interviewTime - now;

        if (diff <= 0) {
            countdownEl.textContent = 'Interview time has passed';
            countdownContainer?.classList.remove('countdown-urgent');
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        let text = '';
        if (days > 0) text = ${days}d ${hours}h ${minutes}m ${seconds}s;
        else if (hours > 0) text = ${hours}h ${minutes}m ${seconds}s;
        else if (minutes > 0) text = ${minutes}m ${seconds}s;
        else text = ${seconds}s;

        countdownEl.textContent = text;

        if (diff <= 3600000) {
            countdownContainer?.classList.add('countdown-urgent');
        } else {
            countdownContainer?.classList.remove('countdown-urgent');
        }
    }

    function updateNextInterviewCountdown() {
        const display = document.getElementById('countdown-display');
        const container = document.getElementById('next-interview-countdown');
        if (!display || interviews.length === 0) return;

        const { date, time } = interviews[0];
        if (!date || !time) {
            display.textContent = 'No upcoming interviews';
            return;
        }

        const now = new Date();
        const target = new Date(${date}T${time});
        const diff = target - now;

        if (diff <= 0) {
            display.textContent = 'Interview time!';
            display.classList.add('text-danger', 'fw-bold');
            container?.classList.remove('countdown-urgent');
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        let text = '';
        if (days > 0) text = ${days}d ${hours}h ${minutes}m;
        else if (hours > 0) text = ${hours}h ${minutes}m ${seconds}s;
        else if (minutes > 0) text = ${minutes}m ${seconds}s;
        else text = ${seconds}s;

        display.textContent = text;
        display.classList.remove('text-danger', 'fw-bold');

        if (diff <= 3600000) {
            container?.classList.add('countdown-urgent');
        } else {
            container?.classList.remove('countdown-urgent');
        }
    }

    function updateInterviewCount() {
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0];
        const currentTime = now.toTimeString().split(' ')[0];

        const upcoming = interviews.filter(({ date, time }) => {
            if (!date || !time) return false;
            if (date < currentDate) return false;
            if (date === currentDate && time < currentTime) return false;
            return true;
        });

        const el = document.getElementById('interview-count');
        if (el) el.textContent = upcoming.length;
    }

    function updateAllCountdowns() {
        interviews.forEach(i => updateCountdown(i.id, i.date, i.time));
        updateNextInterviewCountdown();
    }

    updateAllCountdowns();
    updateInterviewCount();

    setInterval(updateAllCountdowns, 1000);
    setInterval(updateInterviewCount, 60000);
});
</script>

<script>
// INTERVIEW CALENDAR
document.addEventListener('DOMContentLoaded', function () {
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];

    function renderCalendar() {
        const calendarContainer = document.getElementById('interview-calendar');
        if (!calendarContainer) return;

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const today = new Date();
        const todayDate = today.toISOString().split('T')[0];
        const todayTime = today.toTimeString().split(' ')[0];

        let html = `
            <div class="calendar">
              <div class="calendar-header">
                <div class="calendar-nav">
                  <button onclick="previousMonth()">&lt; Previous</button>
                  <button onclick="nextMonth()">Next &gt;</button>
                </div>
                <div class="calendar-title">${monthNames[currentMonth]} ${currentYear}</div>
              </div>
              <div class="calendar-grid">
                ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => <div class="calendar-day-header">${d}</div>).join('')}
        `;

        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];

            const isToday = dateStr === todayDate;
            const isOtherMonth = date.getMonth() !== currentMonth;

            const dayInterviews = calendarInterviews.filter(interview => {
                if (!interview.date) return false;
                const sameDate = interview.date === dateStr;
                if (!sameDate) return false;
                if (interview.date < todayDate) return false;
                if (interview.date === todayDate && interview.time < todayTime) return false;
                return true;
            });

            let dayClass = 'calendar-day';
            if (isOtherMonth) dayClass += ' other-month';
            if (isToday) dayClass += ' today';
            if (dayInterviews.length > 0) dayClass += ' has-interview';

            html += `<div class="${dayClass}" data-date="${dateStr}">
                      <div class="day-number">${date.getDate()}</div>`;
            if (dayInterviews.length > 0) {
                html += <div class="interview-indicator"></div><div class="interview-details">;
                dayInterviews.forEach(interview => {
                    const time = interview.time ? interview.time.substring(0, 5) : 'TBD';
                    html += `
                      <div class="interview-time">${time}</div>
                      <div class="interview-job">${interview.title}</div>
                      <div class="interview-round">Round ${interview.round_number} - ${interview.round_type || 'Interview'}</div>`;
                });
                html += </div>;
            }
            html += </div>;
        }

        html += `
              </div>
              <div class="calendar-legend">
                <div class="legend-item">
                  <div class="legend-color legend-today"></div>
                  <span>Today</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color legend-interview"></div>
                  <span>Interview Scheduled</span>
                </div>
              </div>
            </div>`;

        calendarContainer.innerHTML = html;
    }

    window.previousMonth = function () {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar();
    };

    window.nextMonth = function () {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar();
    };

    renderCalendar();
});
</script>
<script>
  let profileCompletion = {{ profile_completion|default:0 }};

  const ctx = document.getElementById('profileCompletionChart').getContext('2d');
  const profileCompletionChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [profileCompletion, 100 - profileCompletion],
        backgroundColor: ['#ff4c60', '#f0f0f0'],
        borderWidth: 0,
      }]
    },
    options: {
      cutout: '80%',
      responsive: true,
      plugins: {
        tooltip: { enabled: false },
        legend: { display: false },
      }
    }
  });
</script>


{%Â endblockÂ %}
