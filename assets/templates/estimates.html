{% extends 'base.html' %}
{% block title %}Qubits HRMS | Estimates{% endblock %}
{% load hr_tags %}  <!-- Load your custom filter -->

{% block content %}
<style>.select-arrow-spacing {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;

  background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='30' viewBox='0 0 24 24' width='30' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;

  /* ðŸ‘‡ Arrow spacing from the right */
  background-position: right 14px center;

  /* ðŸ‘‡ Add right padding so text doesn't collide with the arrow */
  padding-right: 38px;

  background-size: 24px;
}

</style>

    <!-- Page Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h3 class="page-title">Estimates</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="">Accounts</a></li>
                    <li class="breadcrumb-item active">Estimates</li>
                </ul>
            </div>
{% if request.user.role == "company_owner" or request.user.employee_account.department.name == "Human Resources" %}
    <a href="{% url 'estimate_create' %}" class="btn btn-primary rounded-pill"><i class="fas fa-plus"></i> Create Estimate</a>
{% endif %}


        </div>
    </div>
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

    <!-- Search Filter -->
    <div class="row">
  <div class="col-md-12">
<form method="get" class="row g-3 mb-4">
  <div class="col-12 col-sm-6 col-md-3">
    <label class="form-label">Estimate Number</label>
    <input type="text" name="estimate_number" class="form-control" placeholder="Enter Estimate Number" value="{{ request.GET.estimate_number }}">
  </div>

  <div class="col-12 col-sm-6 col-md-3">
    <label class="form-label">Client Name</label>
    <input type="text" name="client_name" class="form-control" placeholder="Enter Client Name" value="{{ request.GET.client_name }}">
  </div>

  <div class="col-12 col-sm-6 col-md-3">
    <label class="form-label">Status</label>
    <select name="status" class="form-control">
      <option value="">-- All Status --</option>
      <option value="Draft" {% if request.GET.status == 'Draft' %}selected{% endif %}>Draft</option>
      <option value="Sent" {% if request.GET.status == 'Sent' %}selected{% endif %}>Sent</option>
      <option value="Accepted" {% if request.GET.status == 'Accepted' %}selected{% endif %}>Accepted</option>
      <option value="Declined" {% if request.GET.status == 'Declined' %}selected{% endif %}>Declined</option>
    </select>
  </div>

  <div class="col-12 col-sm-6 col-md-3 d-flex align-items-end">
   <button type="submit" class="btn btn-primary" style="width: 100%; height: 42px;">Search</button>
  </div>
</form>

  </div>
</div> 
    <!-- /Search Filter -->

    <div class="row">
  <div class="col-md-12">
    <div class="table-responsive">
      <table class="table table-striped custom-table mb-0">
        <thead>
          <tr>
            <th>Estimate Number</th>
            <th>Client</th>
            <th>Project</th>
            <th>Estimate Date</th>
            <th>Expiry Date</th>
            <th>Tax (%)</th>
            <th>Tax Amount</th>
            <th>Total Amount</th>
            <th>Status</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          {% if estimates %}
            {% for estimate in estimates %}
            <tr>
              <td><a href="{% url 'estimate_detail' estimate.id %}">{{ estimate.estimate_number }}</a></td>
              <td>{{ estimate.client.client_name }}</td>
              <td>{{ estimate.project.name }}</td>
              <td>{{ estimate.estimate_date }}</td>
              <td>{{ estimate.expiry_date }}</td>
              <td>{{ estimate.tax }}%</td>
              <td>â‚¹{{ estimate.tax_amount }}</td>
              <td>â‚¹{{ estimate.grand_total }}</td>
              <td>
                {% if estimate.status == 'Accepted' %}
                  <span class="badge bg-inverse-success">Accepted</span>
                {% elif estimate.status == 'Declined' %}
                  <span class="badge bg-inverse-danger">Declined</span>
                {% elif estimate.status == 'Expired' %}
                  <span class="badge bg-inverse-warning">Expired</span>
                {% else %}
                  <span class="badge bg-inverse-info">{{ estimate.status }}</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="dropdown dropdown-action">
                  <a href="#" class="action-icon dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    <i class="material-icons">more_vert</i>
                  </a>
                  <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="{% url 'estimate_detail' estimate.id %}">
                      <i class="fa fa-eye m-r-5"></i> View
                    </a>
                    {% if request.user.role == "company_owner" or request.user.employee_account.department.name == "Human Resources" %}
                    <a class="dropdown-item" href="{% url 'estimate_update' estimate.id %}">
                      <i class="fa fa-pencil m-r-5"></i> Edit
                    </a>
                    <a class="dropdown-item text-danger" href="#" data-toggle="modal" data-target="#delete_estimate_{{ estimate.id }}">
                      <i class="fa fa-trash-o m-r-5"></i> Delete
                    </a>
                    {% endif %}
                  </div>
                </div>

                {% if request.user.employee.department.name == "Human Resources" %}
                <!-- Delete Modal -->
                <div class="modal custom-modal fade" id="delete_estimate_{{ estimate.id }}" role="dialog">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-body">
                        <div class="form-header">
                          <h3>Delete Estimate</h3>
                          <p>Are you sure you want to delete this estimate?</p>
                        </div>
                        <div class="modal-btn delete-action">
                          <div class="row">
                            <div class="col-6">
                              <a href="{% url 'estimate_delete' estimate.id %}" class="btn btn-primary continue-btn">Delete</a>
                            </div>
                            <div class="col-6">
                              <a href="javascript:void(0);" data-dismiss="modal" class="btn btn-primary cancel-btn">Cancel</a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="10" class="text-center text-muted py-4">No estimates found.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
      {% if estimates.has_other_pages %}
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if estimates.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ estimates.previous_page_number }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in estimates.paginator.page_range %}
        {% if estimates.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
          <li class="page-item">
            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ num }}">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if estimates.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ estimates.next_page_number }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

    </div>
  </div>

<!-- JS & Datepicker -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        $('.datetimepicker').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true
        });
    });
</script>
{% endblock %}
