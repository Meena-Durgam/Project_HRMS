{% extends 'base.html' %}
{% load static %}
{% block title %}Qubits HRMS | Leave {% endblock %}

{% load widget_tweaks %}

{% block content %}

<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title">Leave</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active">Leave</li>
            </ul>
        </div>
        <div class="col-auto d-flex align-items-center">
            {% if not edit_instance %}
            <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addLeaveModal">
                <i class="fa fa-plus me-1"></i> Apply Leave
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-bs-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Summary -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
        <div class="card text-center border rounded-2">
            <div class="card-body py-3">
                <h4 class="mb-2">Annual Leave</h4>
                <h6 class="fw-bold text-dark mb-0">{{ summary.remaining_total }}</h6>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card text-center border rounded-2">
            <div class="card-body py-3">
                <h4 class="mb-2">Medical Leave</h4>
                <h6 class="fw-bold text-dark mb-0">{{ summary.medical }}</h6>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card text-center border rounded-2">
            <div class="card-body py-3">
                <h4 class="mb-2">Pending Request</h4>
                <h6 class="fw-bold text-dark mb-0">{{ summary.pending }}</h6>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card text-center border rounded-2">
            <div class="card-body py-3">
                <h4 class="mb-2">Total Taken</h4>
                <h6 class="fw-bold text-dark mb-0">{{ summary.total }}</h6>
            </div>
        </div>
    </div>
</div>

<!-- Leave List -->
<div class="row">
    <div class="col-12">
        <div class="table-responsive">
            <table class="table table-striped custom-table mb-0 datatable">
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Days</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Reviewed By</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in leaves %}
<tr>
    <td>{{ item.leave.leave_type.name }}</td>
    <td>{{ item.leave.start_date }}</td>
    <td>{{ item.leave.end_date }}</td>
    <td>{{ item.days_count }}</td>
    <td>{{ item.leave.reason }}</td>
    <td>
        {% if item.leave.status == 'Approved' %}
            <i class="fa fa-dot-circle-o text-success"></i> Approved
        {% elif item.leave.status == "Rejected" %}
            <i class="fa fa-dot-circle-o text-danger"></i> Rejected
        {% else %}
            <i class="fa fa-dot-circle-o text-warning"></i> Pending
        {% endif %}
    </td>
    <td>{{ item.leave.reviewed_by|default:"--" }}</td>
    <td class="text-end">
        {% if item.leave.status == 'Pending' %}
        <div class="dropdown dropdown-action">
            <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="material-icons">more_vert</i>
            </a>
            <div class="dropdown-menu dropdown-menu-end">
                <a class="dropdown-item" href="?edit={{ item.leave.id }}">
                    <i class="bi bi-pencil me-2"></i>Edit
                </a>
                <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteLeaveModal{{ item.leave.id }}">
                    <i class="bi bi-trash me-2"></i> Delete
                </a>
            </div>
        </div>
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
</tr>

<!-- Delete Leave Modal -->
<div class="modal custom-modal fade" id="deleteLeaveModal{{ item.leave.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteLeaveModalLabel{{ item.leave.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{% url 'delete_leave' item.leave.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-header text-center">
                        <h3>Delete Leave</h3>
                        <p>Are you sure you want to delete the leave for 
                           <strong>{{ item.leave.leave_type.name }}</strong> 
                           starting on <strong>{{ item.leave.start_date }}</strong>?</p>
                    </div>
                    <div class="modal-btn delete-action mt-4">
                        <div class="row">
                            <div class="col-6">
                                <button type="submit" class="btn btn-outline-primary btn-block continue-btn">Delete</button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-secondary btn-block cancel-btn" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% empty %}
<tr>
    <td colspan="8" class="text-center text-muted">No leave requests found.</td>
</tr>
{% endfor %}

                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Leave Modal -->
<div class="modal custom-modal fade" id="addLeaveModal" tabindex="-1" aria-labelledby="addLeaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apply Leave</h5>
                <button type="button" class="close" data-bs-dismiss="modal" onclick="location.reload();">
    <span>&times;</span>
</button> 
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6 pt-1">
                            <label class="pt-1">Leave Type <span class="text-danger">*</span></label>
                            {{ form.leave_type|add_class:"form-control select-arrow-spacing" }}
                        </div>
                        <div class="col-md-6 pt-1">
                            <label class="pt-1">Start Date <span class="text-danger">*</span></label>
                            {{ form.start_date|add_class:"form-control" }}
                        </div>
                        <div class="col-md-6 pt-1">
                            <label class="pt-1">End Date <span class="text-danger">*</span></label>
                            {{ form.end_date|add_class:"form-control" }}
                        </div>
                        <div class="col-md-6 pt-1">
                            <label class="pt-1">Remaining Leaves</label>
                            <input type="text" id="remaining-days" class="form-control bg-light" readonly>
                        </div>
                        <div class="col-md-6 pt-1">
                            <label class="pt-1">Days</label>
                            <input type="text" id="calculated-days" class="form-control bg-light" readonly>
                        </div>
                        <div class="col-12 pt-1">
                            <label class="pt-1">Reason <span class="text-danger">*</span></label>
                            {{ form.reason|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="apply_leave" class="btn btn-primary px-5">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
$(document).ready(function () {
    $('#addLeaveModal').on('hidden.bs.modal', function () {
        $('#leaveForm')[0].reset();  // Reset the form
        $('#remaining-days').val('');  // Clear calculated field
        $('#calculated-days').val('');
    });
});
</script>

<!-- Edit Leave Modal -->
{% if edit_instance %}
<script>
    window.addEventListener("load", function () {
        const modal = new bootstrap.Modal(document.getElementById("editLeaveModal"));
        modal.show();
    });
</script>
<div class="modal custom-modal fade" id="editLeaveModal" tabindex="-1" aria-labelledby="editLeaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                    <h5 class="modal-title">Edit Leave</h5>
<button 
    type="button" 
    class="close" 
    onclick="window.location.href='{% url 'employee_leave' %}'"
>
    <span>&times;</span>
</button>
                </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Leave Type <span class="text-danger">*</span></label>
                            {{ form.leave_type|add_class:"form-select" }}
                        </div>
                        <div class="col-md-6">
                            <label>Start Date <span class="text-danger">*</span></label>
                            {{ form.start_date|add_class:"form-control" }}
                        </div>
                        <div class="col-md-6">
                            <label>End Date <span class="text-danger">*</span></label>
                            {{ form.end_date|add_class:"form-control" }}
                        </div>
                        <div class="col-12">
                            <label>Reason <span class="text-danger">*</span></label>
                            {{ form.reason|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="update_leave" class="btn btn-primary px-5">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const leaveModal = document.getElementById('addLeaveModal');
    const leaveForm = document.getElementById('leaveForm');

    leaveModal.addEventListener('hidden.bs.modal', function () {
        leaveForm.reset(); // Reset all form fields
        document.getElementById('remaining-days').value = ''; // Reset calculated fields
        document.getElementById('calculated-days').value = '';
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const editLeaveModal = document.getElementById('editLeaveModal');

    // When modal is hidden, reset the form inside it
    editLeaveModal.addEventListener('hidden.bs.modal', function () {
        const form = editLeaveModal.querySelector('form');
        form.reset();  // Reset form fields to default
        form.action = ""; // Optional: reset form action if dynamically set
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const startDate = document.getElementById("id_start_date");
    const endDate = document.getElementById("id_end_date");
    const daysField = document.getElementById("calculated-days");
    const leaveType = document.getElementById("id_leave_type");
    const remainingField = document.getElementById("remaining-days");

    const remainingData = {{ remaining_days_json|safe }};

    function calculateDays() {
        const start = new Date(startDate.value);
        const end = new Date(endDate.value);
        if (!isNaN(start) && !isNaN(end)) {
            const diff = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            daysField.value = diff > 0 ? diff + " day" + (diff > 1 ? "s" : "") : '';
        } else {
            daysField.value = '';
        }
    }

    function showRemaining() {
        const type = leaveType.value;
        remainingField.value = remainingData[type] ?? '--';
    }

    if (startDate && endDate && daysField) {
        startDate.addEventListener("change", calculateDays);
        endDate.addEventListener("change", calculateDays);
        calculateDays();
    }

    if (leaveType && remainingField) {
        leaveType.addEventListener("change", showRemaining);
        showRemaining();
    }
});
</script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

{% endblock %}