{% extends 'base.html' %}
{% load static %}
{% block title %}Qubits HRMS | Overtime {% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h3 class="page-title">Overtime</h3>
      <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
        <li class="breadcrumb-item active">Overtime</li>
      </ul>
    </div>
    {% if request.user.role == "company_owner" %}
    <div class="col-auto float-right ml-auto">
      <a href="#" class="btn add-btn" data-bs-toggle="modal" data-bs-target="#add_overtime">
        <i class="fa fa-plus"></i> Add Overtime
      </a>
    </div>
    {% endif %}
  </div>
</div>
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-bs-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Stats -->
<div class="row">
  <div class="col-md-6">
    <div class="stats-info">
      <h6>Overtime Employees</h6>
      <h4>{{ employee_count }} <span>this month</span></h4>
    </div>
  </div>
  <div class="col-md-6">
    <div class="stats-info">
      <h6>Overtime Hours</h6>
      <h4>{{ total_hours }} <span>this month</span></h4>
    </div>
  </div>
</div>

<!-- Overtime Table -->
<div class="row mt-4">
  <div class="col-md-12">
    <div class="table-responsive">
      <table class="table table-striped custom-table datatable">
        <thead>
          <tr>
            <th>SL.No.</th>
            <th>Name</th>
            <th>OT Date</th>
            <th>OT Hours</th>
            <th>OT Type</th>
            <th>Assigned By</th>
            {% if request.user.role == 'company_owner' %}
            <th class="text-center">Action</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for ot in grouped_overtimes %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td><a href="#">{{ ot.employee__first_name }} {{ ot.employee__last_name }}</a></td>
            <td>{{ ot.latest_date }}</td>
            <td class="text-center">{{ ot.total_hours }}</td>
            <td>{{ ot.latest_ot_type }}</td>
            <td> {{ ot.assigned_by__email|default:"Not Assigned" }}
</td>
            {% if request.user.role == 'company_owner' %}
            <td class="text-center">
              <div class="dropdown dropdown-action">
                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-ellipsis-v"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editOvertimeModal{{ ot.ot_id }}">
                    <i class="fa fa-pencil me-2"></i> Edit
                  </a>
                  <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteOvertimeModal{{ ot.ot_id }}">
                    <i class="fa fa-trash me-2"></i> Delete
                  </a>
                </div>
              </div>
            </td>
            {% endif %}
          </tr>

          <!-- Delete Overtime Modal -->
          <div class="modal fade" id="deleteOvertimeModal{{ ot.ot_id }}" tabindex="-1" aria-labelledby="deleteOvertimeModalLabel{{ ot.ot_id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content text-center p-4 rounded-4">
                <div class="modal-body">
                  <h3 class="mb-2 fw-semibold">Delete Overtime</h3>
                  <p class="text-muted mb-4" style="font-size: 14px;">
                    Are you sure you want to delete this overtime entry?
                  </p>
                  <form method="post" action="{% url 'delete_overtime' ot.ot_id %}">
                    {% csrf_token %}
                    <div class="d-flex justify-content-center gap-3">
                       <div class="col-6">
                                <button type="submit" class="btn btn-outline-primary btn-block continue-btn">Delete</button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-secondary btn-block cancel-btn" data-bs-dismiss="modal">Cancel</button>
                            </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Overtime Modal -->
          <div class="modal fade" id="editOvertimeModal{{ ot.ot_id }}" tabindex="-1" aria-labelledby="editOvertimeModalLabel{{ ot.ot_id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content p-4 rounded shadow-sm border-0">
                <form method="post" action="{% url 'edit_overtime' ot.ot_id %}">
                  {% csrf_token %}
                  <div class="modal-header border-0">
                    <h3 class="modal-title text-center">Edit Overtime</h3>
                    <button type="button" class="close close-edit-designation" data-bs-dismiss="modal">&times;</button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label for="employee_{{ ot.ot_id }}" class="form-label">Select Employee <span class="text-danger">*</span></label>
                      <select id="employee_{{ ot.ot_id }}" name="employee" class="form-control" required>
                        {% for user in employees %}
                        <option value="{{ user.id }}" {% if user.id == ot.employee__id %}selected{% endif %}>
                          {{ user.get_full_name|default:user.username }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="mb-3">
  <label for="date_{{ ot.ot_id }}" class="form-label">Overtime Date <span class="text-danger">*</span></label>
  <input type="date" id="date_{{ ot.ot_id }}" name="date" class="form-control" value="{{ ot.latest_date|date:'Y-m-d' }}" required>
</div>

                    <div class="mb-3">
                      <label for="hours_{{ ot.ot_id }}" class="form-label">Overtime Hours <span class="text-danger">*</span></label>
                      <input type="number" id="hours_{{ ot.ot_id }}" name="hours" class="form-control" value="{{ ot.total_hours }}" required>
                    </div>
                    <div class="mb-3">
                      <label for="ot_type_{{ ot.ot_id }}" class="form-label">OT Type <span class="text-danger">*</span></label>
                      <select id="ot_type_{{ ot.ot_id }}" name="ot_type" class="form-control" required>
                        <option value="Regular" {% if ot.latest_ot_type == 'Regular' %}selected{% endif %}>Regular</option>
                        <option value="Holiday" {% if ot.latest_ot_type == 'Holiday' %}selected{% endif %}>Holiday</option>
                        <option value="Weekend" {% if ot.latest_ot_type == 'Weekend' %}selected{% endif %}>Weekend</option>
                      </select>
                    </div>
                  </div>
                  <div class="modal-footer border-0 justify-content-center">
                    <button type="submit" class="btn btn-primary px-4" style="border-radius: 20px;">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">No overtime records available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Overtime Modal -->
<div class="modal custom-modal fade" id="add_overtime" tabindex="-1" aria-labelledby="addOvertimeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 rounded shadow-sm border-0">
      <form method="post" action="{% url 'add_overtime' %}">
        {% csrf_token %}
        <div class="modal-header border-0">
          <h3 class="modal-title text-center">Add Overtime</h3>
          <button type="button" class="close close-edit-designation" data-bs-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="add_employee" class="form-label">Select Employee <span class="text-danger">*</span></label>
            <select id="add_employee" name="employee" class="form-control" required>
              {% for user in employees %}
              <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="add_date" class="form-label">Overtime Date <span class="text-danger">*</span></label>
            <input type="date" id="add_date" name="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="add_hours" class="form-label">Overtime Hours <span class="text-danger">*</span></label>
            <input type="number" id="add_hours" name="hours" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="add_ot_type" class="form-label">OT Type <span class="text-danger">*</span></label>
            <select id="add_ot_type" name="ot_type" class="form-control" required>
              <option value="Regular">Regular</option>
              <option value="Holiday">Holiday</option>
              <option value="Weekend">Weekend</option>
            </select>
          </div>
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="submit" class="btn btn-primary px-4" style="border-radius: 20px;">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
