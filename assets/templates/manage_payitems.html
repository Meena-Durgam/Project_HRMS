{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Page Header -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title">Payroll Items</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active">Payroll Items</li>
            </ul>
        </div>
        <div class="col-auto float-end ms-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPayItemModal">
                <i class="fa fa-plus"></i> Add Pay Item
            </button>
        </div>
    </div>
</div>
{% if messages %}
  <div class="messages mt-2">
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% elif message.tags == 'warning' %}alert-warning
                       {% elif message.tags == 'info' %}alert-info
                       {% else %}alert-secondary{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
<button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Page Tabs -->
<div class="page-menu">
    <div class="row">
        <div class="col-sm-12">
            <ul class="nav nav-tabs nav-tabs-bottom">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#tab_additions">Additions</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab_deductions">Deductions</a>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Tab Content -->
<div class="tab-content">

    <!-- Additions Tab -->
    <div class="tab-pane show active" id="tab_additions">
        <div class="card payroll-table mt-3">
            <div class="table-responsive">
                <table class="table table-hover table-center mb-0">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Amount</th>
                            <th>Assign To</th>
                            <th>Specific Employees</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in payitems %}
                            {% if item.item_type == 'earning' %}
                            <tr>
                                <td>{{ item.title }}</td>
                                <td>₹{{ item.amount }}</td>
                                <td>{{ item.get_assign_to_display }}</td>
                                <td>
                                    {% if item.assign_to == 'specific' %}
                                        {% for emp in item.specific_employees.all %}
                                            {{ emp }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        All Employees
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="dropdown dropdown-action">
                                        <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fa fa-ellipsis-v"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end">
                                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#edit_payitem_{{ item.id }}">
                                                <i class="fa fa-pencil me-2 text-warning"></i> Edit
                                            </a>
                                            <a class="dropdown-item text-danger" href="{% url 'delete_payitem' item.id %}" onclick="return confirm('Are you sure?');">
                                                <i class="fa fa-trash me-2"></i> Delete
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Deductions Tab -->
    <div class="tab-pane" id="tab_deductions">
        <div class="card payroll-table mt-3">
            <div class="table-responsive">
                <table class="table table-hover table-center mb-0">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Amount</th>
                            <th>Assign To</th>
                            <th>Specific Employees</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in payitems %}
                            {% if item.item_type == 'deduction' %}
                            <tr>
                                <td>{{ item.title }}</td>
                                <td>₹{{ item.amount }}</td>
                                <td>{{ item.get_assign_to_display }}</td>
                                <td>
                                    {% if item.assign_to == 'specific' %}
                                        {% for emp in item.specific_employees.all %}
                                            {{ emp }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        All Employees
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="dropdown dropdown-action">
                                        <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fa fa-ellipsis-v"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end">
                                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#edit_payitem_{{ item.id }}">
                                                <i class="fa fa-pencil me-2 text-warning"></i> Edit
                                            </a>
                                            <a class="dropdown-item text-danger" href="{% url 'delete_payitem' item.id %}" onclick="return confirm('Are you sure?');">
                                                <i class="fa fa-trash me-2"></i> Delete
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Add Pay Item Modal -->
<div  class="modal custom-modal fade" tabindex="-1" id="addPayItemModal" aria-labelledby="addPayItemModalLabel" >
    <div class="modal-dialog">
        <form method="post" action="{% url 'manage_payitems' %}">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Pay Item</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title <span style="color: red;">*</span></label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Item Type <span style="color: red;">*</span></label>
                        <select name="item_type" class="form-control" required>
                            <option value="">Select Type</option>
                            <option value="earning">Addition</option>
                            <option value="deduction">Deduction</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount <span style="color: red;">*</span></label>
                        <input type="number" name="amount" class="form-control" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign To <span style="color: red;">*</span></label>
                        <select name="assign_to" id="payitem-assign-to" class="form-control" required>
                            <option value="">Select</option>
                            <option value="all">All Employees</option>
                            <option value="specific">Specific Employees</option>
                        </select>
                    </div>
                    <!-- Employee Multi-Select -->
<div class="mb-3" id="employee-select-box" style="display: none;">
    <label class="form-label">Select Employees</label>
    {{ form.specific_employees }}
</div>


                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Add Pay Item</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modals for each item -->
{% for item in payitems %}
<div class="modal custom-modal fade" tabindex="-1" id="edit_payitem_{{ item.id }}" >
    <div class="modal-dialog">
        <form method="post" action="{% url 'edit_payitem' %}">
            {% csrf_token %}
            <input type="hidden" name="item_id" value="{{ item.id }}">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pay Item</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <!-- Title -->
                    <div class="mb-3">
                        <label class="form-label">Title <span style="color: red;">*</span></label>
                        <input type="text" name="title" class="form-control" value="{{ item.title }}" required>
                    </div>

                    <!-- Item Type -->
                    <div class="mb-3">
                        <label class="form-label">Item Type <span style="color: red;">*</span></label>
                        <select name="item_type" class="form-control" required>
                            <option value="earning" {% if item.item_type == 'earning' %}selected{% endif %}>Earning</option>
                            <option value="deduction" {% if item.item_type == 'deduction' %}selected{% endif %}>Deduction</option>
                        </select>
                    </div>

                    <!-- Amount -->
                    <div class="mb-3">
                        <label class="form-label">Amount <span style="color: red;">*</span></label>
                        <input type="number" name="amount" class="form-control" value="{{ item.amount }}" required>
                    </div>

                    <!-- Assign To -->
                    <div class="mb-3">
                        <label class="form-label">Assign To <span style="color: red;">*</span></label>
                        <select name="assign_to" class="form-control" onchange="toggleEmployeeSelect(this, '{{ item.id }}')" required>
                            <option value="all" {% if item.assign_to == 'all' %}selected{% endif %}>All Employees</option>
                            <option value="specific" {% if item.assign_to == 'specific' %}selected{% endif %}>Specific Employees</option>
                        </select>
                    </div>

                    <!-- Specific Employees -->
                    <div class="mb-3" id="employee-select-box-{{ item.id }}" {% if item.assign_to != 'specific' %}style="display:none;"{% endif %}>
    <label class="form-label">Select Employees</label>
    <select name="specific_employees" class="form-select select2" multiple style="width: 100%;">
        {% for emp in item.company.employees.all %}
            <option value="{{ emp.id }}" {% if emp in item.specific_employees.all %}selected{% endif %}>
                {{ emp.first_name }} {{ emp.last_name }} ({{ emp.employee_id }})
            </option>
        {% endfor %}
    </select>
</div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<!-- JavaScript to show/hide employee selector -->

<script>
    function toggleEmployeeSelect(selectElement, itemId) {
        var box = document.getElementById('employee-select-box-' + itemId);
        if (selectElement.value === 'specific') {
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const assignToSelect = document.getElementById('payitem-assign-to');
    const employeeBox = document.getElementById('employee-select-box');

    function toggleEmployeeBox() {
        if (assignToSelect.value === 'specific') {
            employeeBox.style.display = 'block';
        } else {
            employeeBox.style.display = 'none';
        }
    }

    // Run on page load and on change
    toggleEmployeeBox();
    assignToSelect.addEventListener('change', toggleEmployeeBox);
});
</script>

{% endblock %}
